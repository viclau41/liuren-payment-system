<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大六壬智慧排盤 - Victor AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', Arial, "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .taichi-bg {
            position: absolute;
            width: 140px;
            height: 140px;
            background-image: url('https://victorlau.myqnapcloud.com/taichi.webp');
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 0.15;
            z-index: 1;
            animation: rotate 20s linear infinite;
            pointer-events: none;
        }
        .taichi-bg.left {
            top: -30px;
            left: -30px;
        }
        .taichi-bg.right {
            bottom: -30px;
            right: -30px;
        }
        .bagua-bg {
            position: absolute;
            bottom: -120px;
            right: -120px;
            width: 300px;
            height: 300px;
            background-image: url('https://victorlau.myqnapcloud.com/taichi.webp');
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 0.03;
            z-index: 0;
            animation: slowRotate 80s linear infinite reverse;
            pointer-events: none;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes slowRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .header {
            background: linear-gradient(120deg, #336633, #2f4f4f);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('https://victorlau.myqnapcloud.com/taichi.webp');
            background-repeat: no-repeat;
            background-position: right center;
            background-size: 200px;
            opacity: 0.1;
            z-index: 0;
            animation: pulse 8s infinite ease-in-out;
        }

        .header h1,
        .header p {
            position: relative;
            z-index: 2;
        }

        .quota-banner {
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
            border: 2px solid #68d391;
            border-radius: 15px;
            padding: 15px 20px;
            margin: 20px 30px;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .quota-banner.warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
        }

        .quota-banner.empty {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: #f87171;
        }

        .content {
            padding: 30px;
            position: relative;
            z-index: 2;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #336633;
            box-shadow: 0 0 0 3px rgba(51,102,51,0.1);
        }

        .generate-btn {
            width: 100%;
            background: linear-gradient(135deg, #336633 0%, #2f4f4f 100%);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(51,102,51,0.3);
        }

        .generate-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .loading-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #336633;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            margin-top: 20px;
            color: #718096;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .taichi-bg {
                width: 80px;
                height: 80px;
            }
            .bagua-bg {
                width: 200px;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="main-card">
        <div class="bagua-bg"></div>

        <div class="header">
            <div class="taichi-bg left"></div>
            <div class="taichi-bg right"></div>

            <h1 style="font-size: 28px; margin-bottom: 10px;">🧮 大六壬智慧排盤</h1>
            <p style="opacity: 0.9;">Victor AI 主理</p>
        </div>

        <!-- 剩余次数横幅 -->
        <div id="quota-banner" class="quota-banner" style="display:none;">
            <p id="quota-text" style="font-weight: 600; font-size: 16px; margin: 0;"></p>
        </div>

        <div class="content">
            <div class="input-group">
                <label for="question">📝 占問事項</label>
                <textarea
                    id="question"
                    rows="3"
                    placeholder="請輸入您想要占問的事情，例如：問今日財運如何？"
                    required
                ></textarea>
            </div>

            <div class="input-group">
                <label for="datetime">📅 選擇現在或自選日期時間</label>
                <input
                    type="datetime-local"
                    id="datetime"
                    required
                >
            </div>

            <button class="generate-btn" onclick="generateReport()">
                🎯 開始排盤與分析
            </button>

            <div class="footer">
                © 2025 Victor AI 主理 · 僅供參考
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let currentAccessCode = '';
        let remainingQuota = 0;

        // 上傳API URL
        const UPLOAD_API_URL = 'https://victorlau.myqnapcloud.com/upload-report.php';

        // 页面加载时验证起卦码
        window.addEventListener('DOMContentLoaded', async function() {
            setCurrentTime();
            await verifyAccessCode();
        });

        // 从 URL 参数获取起卦码
        function getAccessCodeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('code');
        }

        // 验证起卦码
        async function verifyAccessCode() {
            const code = getAccessCodeFromURL();

            if (!code) {
                showAlert('⚠️ 未找到起卦碼，請返回首頁重新輸入');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }

            try {
                const response = await fetch('/api/check-quota', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code.toUpperCase() })
                });

                const result = await response.json();

                if (!result.success) {
                    showAlert('❌ ' + (result.error || '起卦碼無效'));
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }

                // 保存起卦码和剩余次数
                currentAccessCode = code.toUpperCase();
                remainingQuota = result.remaining;

                // 显示剩余次数
                updateQuotaBanner();

                if (remainingQuota <= 0) {
                    showAlert('⚠️ 此起卦碼已用完所有次數，請返回首頁重新購買');
                    document.querySelector('.generate-btn').disabled = true;
                }

            } catch (error) {
                showAlert('❌ 驗證失敗：' + error.message);
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        }

        // 更新剩余次数横幅
        function updateQuotaBanner() {
            const banner = document.getElementById('quota-banner');
            const text = document.getElementById('quota-text');

            banner.style.display = 'block';

            if (remainingQuota === 0) {
                banner.className = 'quota-banner empty';
                text.innerHTML = '❌ 剩餘次數：0 次 - 請返回首頁重新購買';
            } else if (remainingQuota === 1) {
                banner.className = 'quota-banner warning';
                text.innerHTML = '⚠️ 剩餘次數：1 次 - 即將用完';
            } else {
                banner.className = 'quota-banner';
                text.innerHTML = `✅ 剩餘次數：${remainingQuota} 次`;
            }
        }

        // 設置當前時間
        function setCurrentTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('datetime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // 自定义 Alert 函数
        function showAlert(message) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;';
            modal.innerHTML = `
                <div style="background:white;padding:30px;border-radius:15px;max-width:400px;width:90%;box-shadow:0 10px 30px rgba(0,0,0,0.3);">
                    <p style="color:#2d3748;margin-bottom:20px;font-size:16px;line-height:1.6;">${message}</p>
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="width:100%;background:#336633;color:white;padding:12px;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:600;">確定</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 顯示加載動畫
        function showLoading(message) {
            const modal = document.createElement('div');
            modal.id = 'loading-modal';
            modal.className = 'loading-modal';
            modal.innerHTML = `
                <div class="loading-content">
                    <div class="spinner"></div>
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">${message}</h3>
                    <p id="loading-status" style="color: #718096; font-size: 14px;">正在準備...</p>
                    <p style="margin-top: 15px; color: #718096; font-size: 12px;">
                        已用時：<span id="timer" style="font-family: monospace;">00:00</span>
                    </p>
                </div>
            `;
            document.body.appendChild(modal);

            // 啟動計時器
            const startTime = Date.now();
            const timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                const timerEl = document.getElementById('timer');
                const statusEl = document.getElementById('loading-status');

                if (timerEl) {
                    timerEl.textContent = timeString;
                }

                if (statusEl) {
                    let statusMessage = '';
                    let subMessage = '';
                    let progress = 0;

                    if (elapsed < 5) {
                        statusMessage = '⚙️ 正在準備盤式資料';
                        progress = 2;
                    } else if (elapsed < 10) {
                        statusMessage = '🧮 正在計算四柱與月將';
                        progress = 5;
                    } else if (elapsed < 20) {
                        statusMessage = '📊 正在排定天盤地盤與四課';
                        progress = 10;
                    } else if (elapsed < 30) {
                        statusMessage = '🎯 正在推算三傳與課體';
                        progress = 15;
                    } else if (elapsed < 45) {
                        statusMessage = '🤖 正在啟動 Victor AI 專業分析系統';
                        subMessage = '六壬智慧引擎準備中...';
                        progress = 20;
                    } else if (elapsed < 90) {
                        statusMessage = '🧠 AI 正在深度分析課式';
                        subMessage = '預計需時 3-4 分鐘，正在分析天將與神煞配置...';
                        progress = 20 + Math.floor(((elapsed - 45) / 45) * 30);
                    } else if (elapsed < 150) {
                        statusMessage = '📝 AI 正在整合六親與吉凶判斷';
                        subMessage = '正在參考古籍理論與現代應用...';
                        progress = 50 + Math.floor(((elapsed - 90) / 60) * 25);
                    } else if (elapsed < 210) {
                        statusMessage = '✨ AI 正在生成專業分析報告';
                        subMessage = '即將完成，感謝您的耐心等待...';
                        progress = 75 + Math.floor(((elapsed - 150) / 60) * 20);
                    } else if (elapsed < 240) {
                        statusMessage = '📤 正在上傳報告到服務器';
                        progress = 95;
                    } else {
                        statusMessage = '🎉 即將完成';
                        progress = 99;
                    }

                    statusEl.innerHTML = `
                        <div style="font-size: 14px; margin-bottom: 8px;">${statusMessage}</div>
                        ${subMessage ? `<div style="font-size: 12px; color: #718096; margin-bottom: 10px;">${subMessage}</div>` : ''}
                        <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 10px;">
                            <div style="background: linear-gradient(90deg, #336633, #5D5CDE); height: 100%; width: ${progress}%; transition: width 0.5s ease;"></div>
                        </div>
                        <div style="font-size: 11px; color: #5D5CDE; font-weight: 600; margin-top: 5px;">${progress}%</div>
                    `;
                }
            }, 1000);

            modal.timerInterval = timerInterval;
        }

        function hideLoading() {
            const modal = document.getElementById('loading-modal');
            if (modal) {
                if (modal.timerInterval) {
                    clearInterval(modal.timerInterval);
                }
                modal.remove();
            }
        }

        // 顯示成功模態框
        function showSuccessModal(reportUrl) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10000;';
            modal.innerHTML = `
                <div style="background:white;padding:40px;border-radius:20px;max-width:500px;width:90%;text-align:center;">
                    <h2 style="color:#38a169;font-size:32px;margin-bottom:20px;">✅ 報告生成成功！</h2>
                    <p style="color:#4a5568;margin-bottom:15px;">您的大六壬分析報告已經生成</p>
                    <div style="background:#f0fff4;border:2px solid #68d391;border-radius:12px;padding:20px;margin:20px 0;word-break:break-all;font-family:monospace;font-size:14px;">
                        ${reportUrl}
                    </div>
                    <button onclick="window.open('${reportUrl}', '_blank')" style="width:100%;background:linear-gradient(135deg,#336633 0%,#2f4f4f 100%);color:white;padding:15px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:10px;">
                        🔗 打開報告
                    </button>
                    <button onclick="copyUrlAndReload('${reportUrl}')" style="width:100%;background:#3182ce;color:white;padding:15px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:10px;">
                        📋 複製鏈接並繼續
                    </button>
                    <button onclick="location.reload()" style="width:100%;background:#718096;color:white;padding:12px;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;">
                        🔄 返回繼續排盤
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function copyUrlAndReload(url) {
            navigator.clipboard.writeText(url).then(() => {
                showAlert('✅ 鏈接已複製到剪貼板！');
                setTimeout(() => location.reload(), 1500);
            }).catch(() => {
                showAlert('複製失敗，請手動複製鏈接');
            });
        }

        // 從後端獲取專業Prompt
        async function getPromptFromBackend(liurenBriefing, question, isAutoAnalysis) {
            try {
                const response = await fetch('https://liuren-api.vercel.app/api/liuren/get-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        liurenBriefing: liurenBriefing,
                        question: question,
                        isAutoAnalysis: isAutoAnalysis
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.prompt) {
                        return data.prompt;
                    }
                }
                throw new Error('後端API返回錯誤');
            } catch (error) {
                console.error('後端API調用失敗:', error);
                return null;
            }
        }

        // 上傳報告到服務器
        async function uploadReportToServer(htmlContent, fileName) {
            try {
                const response = await fetch(UPLOAD_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: fileName,
                        content: htmlContent
                    })
                });

                if (!response.ok) {
                    throw new Error('上傳失敗');
                }

                const result = await response.json();
                if (result.success) {
                    return result.url;
                } else {
                    throw new Error(result.error || '上傳失敗');
                }
            } catch (error) {
                console.error('上傳報告錯誤:', error);
                throw error;
            }
        }

        // 生成報告（主函数）
        async function generateReport() {
            const question = document.getElementById('question').value.trim();
            const datetime = document.getElementById('datetime').value;

            if (!question) {
                showAlert('請輸入詳細占問事項！');
                return;
            }

            if (!datetime) {
                showAlert('請選擇現在或自選日期時間！');
                return;
            }

            if (remainingQuota <= 0) {
                showAlert('❌ 起卦次數已用完，請返回首頁重新購買');
                return;
            }

            showLoading('正在生成您的六壬分析報告');

            try {
                // 第一步：調用六壬計算API
                const calcResponse = await fetch('https://liuren-api.vercel.app/api/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        datetime: datetime,
                        question: question
                    })
                });

                if (!calcResponse.ok) {
                    throw new Error('排盤計算失敗');
                }

                const result = await calcResponse.json();

                if (!result.success) {
                    throw new Error(result.error || '排盤失敗');
                }

                // 計算空亡
                const kongwangZhi = calculateKongwang(result.ganzhi.day);

                // 第二步：準備數據結構
                const data = {
                    basicInfo: {
                        占問事項: question,
                        排盤時間: datetime.replace('T', ' '),
                        四柱干支: `${result.ganzhi.year} ${result.ganzhi.month} ${result.ganzhi.day} ${result.ganzhi.hour}`,
                        四柱干支詳細: `${result.ganzhi.year} ${result.ganzhi.month} ${result.ganzhi.day} ${result.ganzhi.hour}${kongwangZhi.length > 0 ? ` (空亡：${kongwangZhi.join('、')})` : ''}`,
                        月將節氣: `${result.yuejiang.name}(${result.yuejiang.dizhi}) - ${result.yuejiang.current_jieqi}`
                    },
                    sike: [1,2,3,4].map(i => ({
                        課: `第${i}課(${i<=2?'干':'支'}課)`,
                        上: result.sike[`course${i}`].up,
                        下: result.sike[`course${i}`].down,
                        天將: result.sike[`course${i}`].tianjiang
                    })),
                    sanchuan: {
                        初傳: `(${result.sanchuan.chu.liuqin}神)：【${result.sanchuan.chu.ganzhi}】配${result.sanchuan.chu.tianjiang}`,
                        中傳: `(${result.sanchuan.zhong.liuqin}神)：【${result.sanchuan.zhong.ganzhi}】配${result.sanchuan.zhong.tianjiang}`,
                        末傳: `(${result.sanchuan.mo.liuqin}神)：【${result.sanchuan.mo.ganzhi}】配${result.sanchuan.mo.tianjiang}`
                    },
                    ketiAnalysis: {
                        課體: result.keti?.name || '常規課體',
                        課體釋義: result.keti?.description || '按一般法則分析',
                        發用取法: result.sanchuan.method
                    }
                };

                // 第三步：生成結構化數據文本
                const structuredData = generateStructuredDataText(data, result);

                // 第四步：調用AI獲取綜合分析
                const aiPrompt = await getPromptFromBackend(structuredData, question, true);

                let autoAnalysisResult = '';
                try {
                    const aiResponse = await fetch('https://poe-api-backend.vercel.app/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: aiPrompt || buildBackupPrompt(structuredData, question),
                            model: 'Claude-Sonnet-4.5'
                        })
                    });

                    if (aiResponse.ok) {
                        const aiData = await aiResponse.json();
                        const aiText = aiData.response || aiData.text || aiData.message || '';
                        autoAnalysisResult = aiText.replace(/\n/g, '<br>');
                    } else {
                        throw new Error('AI分析失敗');
                    }
                } catch (error) {
                    autoAnalysisResult = `<div style="color:red;border:1px solid red;padding:10px;border-radius:5px;"><h4>❌ 自動分析失敗</h4><p>原因：${error.message}</p></div>`;
                }

                // 第五步：生成HTML報告
                const reportHTML = generateClientReportHTML(data, result, autoAnalysisResult, kongwangZhi);

                // 第六步：生成文件名並上傳到服務器
                const reportId = generateSimpleSecureId();
                const timestamp = new Date().toISOString().slice(0,16).replace(/[-:T]/g, '');
                const fileName = `${reportId}_${timestamp}.html`;

                // 上傳到服務器
const reportUrl = await uploadReportToServer(reportHTML, fileName);

// ✅ 報告成功生成並上傳後，才扣除配額
try {
    const deductResponse = await fetch('/api/use-quota', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: currentAccessCode })
    });

    const deductResult = await deductResponse.json();

    if (deductResult.success) {
        // 更新剩余次数
        remainingQuota = deductResult.remaining;
        updateQuotaBanner();
    } else {
        console.warn('配額扣除失敗，但報告已生成:', deductResult.error);
    }
} catch (quotaError) {
    console.warn('配額扣除請求失敗，但報告已生成:', quotaError);
}

hideLoading();

// 顯示成功模態框
showSuccessModal(reportUrl);

            } catch (error) {
                hideLoading();
                showAlert('❌ 生成失敗：' + error.message);
                console.error('生成報告錯誤:', error);
            }
        }

        // 生成結構化數據文本
        function generateStructuredDataText(data, result) {
            let output = '=== 大六壬專業分析數據包 ===\n\n';

            output += '【第一層：時空基礎】\n';
            output += `占問事項：${data.basicInfo.占問事項}\n`;
            output += `排盤時間：${data.basicInfo.排盤時間}\n`;
            output += `四柱干支：${data.basicInfo.四柱干支詳細}\n`;
            output += `月將節氣：${data.basicInfo.月將節氣}\n\n`;

            output += '【第二層：課式核心】\n';
            output += '四課詳細配置：\n';
            data.sike.forEach((course, i) => {
                output += `第${i+1}課（${i<2?'日干課':'日支課'}）\n`;
                output += `    ┌─ 上神：${course.上}\n`;
                output += `    ├─ 下神：${course.下}\n`;
                output += `    └─ 天將：${course.天將}\n\n`;
            });

            output += '三傳流轉：\n';
            output += `- 初傳：${data.sanchuan.初傳}\n`;
            output += `- 中傳：${data.sanchuan.中傳}\n`;
            output += `- 末傳：${data.sanchuan.末傳}\n\n`;

            output += '課體診斷：\n';
            output += `課體：${data.ketiAnalysis.課體}\n`;
            output += `發用取法：${data.ketiAnalysis.發用取法}\n\n`;

            return output;
        }

        // 備用Prompt
        function buildBackupPrompt(structuredData, question) {
            return `你是 Victor AI 六壬智慧助手。請根據以下盤式資料進行專業六壬分析。

【占問事項】${question}

【盤式資料】
${structuredData}

請根據六壬原理進行專業分析，給出明確的吉凶判斷和建議。`;
        }

        // 生成報告ID
        function generateSimpleSecureId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const timestamp = Date.now().toString(36).slice(-6);
            let randomPart = '';
            for (let i = 0; i < 4; i++) {
                randomPart += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return `LR${timestamp}${randomPart}`;
        }

        // 計算空亡
        function calculateKongwang(dayGanzhi) {
            const KONGWANG_MAP = {
                '甲子': ['戌', '亥'], '乙丑': ['戌', '亥'], '丙寅': ['戌', '亥'], '丁卯': ['戌', '亥'],
                '戊辰': ['戌', '亥'], '己巳': ['戌', '亥'], '庚午': ['戌', '亥'], '辛未': ['戌', '亥'],
                '壬申': ['戌', '亥'], '癸酉': ['戌', '亥'], '甲戌': ['申', '酉'], '乙亥': ['申', '酉'],
                '丙子': ['申', '酉'], '丁丑': ['申', '酉'], '戊寅': ['申', '酉'], '己卯': ['申', '酉'],
                '庚辰': ['申', '酉'], '辛巳': ['申', '酉'], '壬午': ['申', '酉'], '癸未': ['申', '酉'],
                '甲申': ['午', '未'], '乙酉': ['午', '未'], '丙戌': ['午', '未'], '丁亥': ['午', '未'],
                '戊子': ['午', '未'], '己丑': ['午', '未'], '庚寅': ['午', '未'], '辛卯': ['午', '未'],
                '壬辰': ['午', '未'], '癸巳': ['午', '未'], '甲午': ['辰', '巳'], '乙未': ['辰', '巳'],
                '丙申': ['辰', '巳'], '丁酉': ['辰', '巳'], '戊戌': ['辰', '巳'], '己亥': ['辰', '巳'],
                '庚子': ['辰', '巳'], '辛丑': ['辰', '巳'], '壬寅': ['辰', '巳'], '癸卯': ['辰', '巳'],
                '甲辰': ['寅', '卯'], '乙巳': ['寅', '卯'], '丙午': ['寅', '卯'], '丁未': ['寅', '卯'],
                '戊申': ['寅', '卯'], '己酉': ['寅', '卯'], '庚戌': ['寅', '卯'], '辛亥': ['寅', '卯'],
                '壬子': ['寅', '卯'], '癸丑': ['寅', '卯'], '甲寅': ['子', '丑'], '乙卯': ['子', '丑'],
                '丙辰': ['子', '丑'], '丁巳': ['子', '丑'], '戊午': ['子', '丑'], '己未': ['子', '丑'],
                '庚申': ['子', '丑'], '辛酉': ['子', '丑'], '壬戌': ['子', '丑'], '癸亥': ['子', '丑']
            };
            return KONGWANG_MAP[dayGanzhi] || [];
        }

        // 生成客戶報告HTML（使用你原程序的完整函数 - 这里简化显示）
        function generateClientReportHTML(data, result, autoAnalysisResult, kongwangZhi) {
            const tianpanData = result.tianpan.positions;
            const tianjiangData = result.tianjiang.positions;
            const kongwangInfo = {
                dayGanzhi: result.ganzhi.day,
                kongwangZhi: kongwangZhi
            };
            const chatHistoryJSON = JSON.stringify([]);
            const clientJS = generateClientJS(data, tianpanData, tianjiangData, kongwangInfo, chatHistoryJSON);
            const clientHTML = generateClientHTML(data, autoAnalysisResult, clientJS);
            return clientHTML;
        }

        // 这里需要包含你原程序的 generateClientJS 和 generateClientHTML 函数
        // 由于太长，我会在下一个文件中创建
        function generateClientJS(data, tianpanData, tianjiangData, kongwangInfo, chatHistoryJSON) {
            // 简化版本 - 实际应该使用你原程序的完整代码
            return `console.log('Report loaded');`;
        }

        function generateClientHTML(data, autoAnalysisResult, clientJS) {
            // 简化版本 - 实际应该使用你原程序的完整代码
            return '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>報告</title></head><body><h1>報告生成成功</h1><p>' + autoAnalysisResult + '</p><script>' + clientJS + '<' + '/script></body></html>';
        }
    </script>
</body>
</html>
