<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å…­å£¬æ™ºæ…§æ’ç›¤ - Victor AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', Arial, "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .taichi-bg {
            position: absolute;
            width: 140px;
            height: 140px;
            background-image: url('https://victorlau.myqnapcloud.com/taichi.webp');
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 0.15;
            z-index: 1;
            animation: rotate 20s linear infinite;
            pointer-events: none;
        }
        .taichi-bg.left {
            top: -30px;
            left: -30px;
        }
        .taichi-bg.right {
            bottom: -30px;
            right: -30px;
        }
        .bagua-bg {
            position: absolute;
            bottom: -120px;
            right: -120px;
            width: 300px;
            height: 300px;
            background-image: url('https://victorlau.myqnapcloud.com/taichi.webp');
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 0.03;
            z-index: 0;
            animation: slowRotate 80s linear infinite reverse;
            pointer-events: none;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes slowRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .header {
            background: linear-gradient(120deg, #336633, #2f4f4f);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('https://victorlau.myqnapcloud.com/taichi.webp');
            background-repeat: no-repeat;
            background-position: right center;
            background-size: 200px;
            opacity: 0.1;
            z-index: 0;
            animation: pulse 8s infinite ease-in-out;
        }

        .header h1,
        .header p {
            position: relative;
            z-index: 2;
        }

        .quota-banner {
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
            border: 2px solid #68d391;
            border-radius: 15px;
            padding: 15px 20px;
            margin: 20px 30px;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .quota-banner.warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
        }

        .quota-banner.empty {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: #f87171;
        }

        .content {
            padding: 30px;
            position: relative;
            z-index: 2;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #336633;
            box-shadow: 0 0 0 3px rgba(51,102,51,0.1);
        }

        .generate-btn {
            width: 100%;
            background: linear-gradient(135deg, #336633 0%, #2f4f4f 100%);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(51,102,51,0.3);
        }

        .generate-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .loading-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #336633;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            margin-top: 20px;
            color: #718096;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .taichi-bg {
                width: 80px;
                height: 80px;
            }
            .bagua-bg {
                width: 200px;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="main-card">
        <div class="bagua-bg"></div>

        <div class="header">
            <div class="taichi-bg left"></div>
            <div class="taichi-bg right"></div>

            <h1 style="font-size: 28px; margin-bottom: 10px;">ğŸ§® å¤§å…­å£¬æ™ºæ…§æ’ç›¤</h1>
            <p style="opacity: 0.9;">Victor AI ä¸»ç†</p>
        </div>

        <!-- å‰©ä½™æ¬¡æ•°æ¨ªå¹… -->
        <div id="quota-banner" class="quota-banner" style="display:none;">
            <p id="quota-text" style="font-weight: 600; font-size: 16px; margin: 0;"></p>
        </div>

        <div class="content">
            <div class="input-group">
                <label for="question">ğŸ“ å å•äº‹é …</label>
                <textarea
                    id="question"
                    rows="3"
                    placeholder="è«‹è¼¸å…¥æ‚¨æƒ³è¦å å•çš„äº‹æƒ…ï¼Œä¾‹å¦‚ï¼šå•ä»Šæ—¥è²¡é‹å¦‚ä½•ï¼Ÿ"
                    required
                ></textarea>
            </div>

            <div class="input-group">
                <label for="datetime">ğŸ“… é¸æ“‡ç¾åœ¨æˆ–è‡ªé¸æ—¥æœŸæ™‚é–“</label>
                <input
                    type="datetime-local"
                    id="datetime"
                    required
                >
            </div>

            <button class="generate-btn" onclick="generateReport()">
                ğŸ¯ é–‹å§‹æ’ç›¤èˆ‡åˆ†æ
            </button>

            <div class="footer">
                Â© 2025 Victor AI ä¸»ç† Â· åƒ…ä¾›åƒè€ƒ
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentAccessCode = '';
        let remainingQuota = 0;

        // ä¸Šå‚³API URL
        const UPLOAD_API_URL = 'https://victorlau.myqnapcloud.com/upload-report.php';

        // é¡µé¢åŠ è½½æ—¶éªŒè¯èµ·å¦ç 
        window.addEventListener('DOMContentLoaded', async function() {
            setCurrentTime();
            await verifyAccessCode();
        });

        // ä» URL å‚æ•°è·å–èµ·å¦ç 
        function getAccessCodeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('code');
        }

        // éªŒè¯èµ·å¦ç 
        async function verifyAccessCode() {
            const code = getAccessCodeFromURL();

            if (!code) {
                showAlert('âš ï¸ æœªæ‰¾åˆ°èµ·å¦ç¢¼ï¼Œè«‹è¿”å›é¦–é é‡æ–°è¼¸å…¥');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }

            try {
                const response = await fetch('/api/check-quota', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code.toUpperCase() })
                });

                const result = await response.json();

                if (!result.success) {
                    showAlert('âŒ ' + (result.error || 'èµ·å¦ç¢¼ç„¡æ•ˆ'));
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }

                // ä¿å­˜èµ·å¦ç å’Œå‰©ä½™æ¬¡æ•°
                currentAccessCode = code.toUpperCase();
                remainingQuota = result.remaining;

                // æ˜¾ç¤ºå‰©ä½™æ¬¡æ•°
                updateQuotaBanner();

                if (remainingQuota <= 0) {
                    showAlert('âš ï¸ æ­¤èµ·å¦ç¢¼å·²ç”¨å®Œæ‰€æœ‰æ¬¡æ•¸ï¼Œè«‹è¿”å›é¦–é é‡æ–°è³¼è²·');
                    document.querySelector('.generate-btn').disabled = true;
                }

            } catch (error) {
                showAlert('âŒ é©—è­‰å¤±æ•—ï¼š' + error.message);
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        }

        // æ›´æ–°å‰©ä½™æ¬¡æ•°æ¨ªå¹…
        function updateQuotaBanner() {
            const banner = document.getElementById('quota-banner');
            const text = document.getElementById('quota-text');

            banner.style.display = 'block';

            if (remainingQuota === 0) {
                banner.className = 'quota-banner empty';
                text.innerHTML = 'âŒ å‰©é¤˜æ¬¡æ•¸ï¼š0 æ¬¡ - è«‹è¿”å›é¦–é é‡æ–°è³¼è²·';
            } else if (remainingQuota === 1) {
                banner.className = 'quota-banner warning';
                text.innerHTML = 'âš ï¸ å‰©é¤˜æ¬¡æ•¸ï¼š1 æ¬¡ - å³å°‡ç”¨å®Œ';
            } else {
                banner.className = 'quota-banner';
                text.innerHTML = `âœ… å‰©é¤˜æ¬¡æ•¸ï¼š${remainingQuota} æ¬¡`;
            }
        }

        // è¨­ç½®ç•¶å‰æ™‚é–“
        function setCurrentTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('datetime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // è‡ªå®šä¹‰ Alert å‡½æ•°
        function showAlert(message) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;';
            modal.innerHTML = `
                <div style="background:white;padding:30px;border-radius:15px;max-width:400px;width:90%;box-shadow:0 10px 30px rgba(0,0,0,0.3);">
                    <p style="color:#2d3748;margin-bottom:20px;font-size:16px;line-height:1.6;">${message}</p>
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="width:100%;background:#336633;color:white;padding:12px;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:600;">ç¢ºå®š</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // é¡¯ç¤ºåŠ è¼‰å‹•ç•«
        function showLoading(message) {
            const modal = document.createElement('div');
            modal.id = 'loading-modal';
            modal.className = 'loading-modal';
            modal.innerHTML = `
                <div class="loading-content">
                    <div class="spinner"></div>
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">${message}</h3>
                    <p id="loading-status" style="color: #718096; font-size: 14px;">æ­£åœ¨æº–å‚™...</p>
                    <p style="margin-top: 15px; color: #718096; font-size: 12px;">
                        å·²ç”¨æ™‚ï¼š<span id="timer" style="font-family: monospace;">00:00</span>
                    </p>
                </div>
            `;
            document.body.appendChild(modal);

            // å•Ÿå‹•è¨ˆæ™‚å™¨
            const startTime = Date.now();
            const timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                const timerEl = document.getElementById('timer');
                const statusEl = document.getElementById('loading-status');

                if (timerEl) {
                    timerEl.textContent = timeString;
                }

                if (statusEl) {
                    let statusMessage = '';
                    let subMessage = '';
                    let progress = 0;

                    if (elapsed < 5) {
                        statusMessage = 'âš™ï¸ æ­£åœ¨æº–å‚™ç›¤å¼è³‡æ–™';
                        progress = 2;
                    } else if (elapsed < 10) {
                        statusMessage = 'ğŸ§® æ­£åœ¨è¨ˆç®—å››æŸ±èˆ‡æœˆå°‡';
                        progress = 5;
                    } else if (elapsed < 20) {
                        statusMessage = 'ğŸ“Š æ­£åœ¨æ’å®šå¤©ç›¤åœ°ç›¤èˆ‡å››èª²';
                        progress = 10;
                    } else if (elapsed < 30) {
                        statusMessage = 'ğŸ¯ æ­£åœ¨æ¨ç®—ä¸‰å‚³èˆ‡èª²é«”';
                        progress = 15;
                    } else if (elapsed < 45) {
                        statusMessage = 'ğŸ¤– æ­£åœ¨å•Ÿå‹• Victor AI å°ˆæ¥­åˆ†æç³»çµ±';
                        subMessage = 'å…­å£¬æ™ºæ…§å¼•æ“æº–å‚™ä¸­...';
                        progress = 20;
                    } else if (elapsed < 90) {
                        statusMessage = 'ğŸ§  AI æ­£åœ¨æ·±åº¦åˆ†æèª²å¼';
                        subMessage = 'é è¨ˆéœ€æ™‚ 3-4 åˆ†é˜ï¼Œæ­£åœ¨åˆ†æå¤©å°‡èˆ‡ç¥ç…é…ç½®...';
                        progress = 20 + Math.floor(((elapsed - 45) / 45) * 30);
                    } else if (elapsed < 150) {
                        statusMessage = 'ğŸ“ AI æ­£åœ¨æ•´åˆå…­è¦ªèˆ‡å‰å‡¶åˆ¤æ–·';
                        subMessage = 'æ­£åœ¨åƒè€ƒå¤ç±ç†è«–èˆ‡ç¾ä»£æ‡‰ç”¨...';
                        progress = 50 + Math.floor(((elapsed - 90) / 60) * 25);
                    } else if (elapsed < 210) {
                        statusMessage = 'âœ¨ AI æ­£åœ¨ç”Ÿæˆå°ˆæ¥­åˆ†æå ±å‘Š';
                        subMessage = 'å³å°‡å®Œæˆï¼Œæ„Ÿè¬æ‚¨çš„è€å¿ƒç­‰å¾…...';
                        progress = 75 + Math.floor(((elapsed - 150) / 60) * 20);
                    } else if (elapsed < 240) {
                        statusMessage = 'ğŸ“¤ æ­£åœ¨ä¸Šå‚³å ±å‘Šåˆ°æœå‹™å™¨';
                        progress = 95;
                    } else {
                        statusMessage = 'ğŸ‰ å³å°‡å®Œæˆ';
                        progress = 99;
                    }

                    statusEl.innerHTML = `
                        <div style="font-size: 14px; margin-bottom: 8px;">${statusMessage}</div>
                        ${subMessage ? `<div style="font-size: 12px; color: #718096; margin-bottom: 10px;">${subMessage}</div>` : ''}
                        <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 10px;">
                            <div style="background: linear-gradient(90deg, #336633, #5D5CDE); height: 100%; width: ${progress}%; transition: width 0.5s ease;"></div>
                        </div>
                        <div style="font-size: 11px; color: #5D5CDE; font-weight: 600; margin-top: 5px;">${progress}%</div>
                    `;
                }
            }, 1000);

            modal.timerInterval = timerInterval;
        }

        function hideLoading() {
            const modal = document.getElementById('loading-modal');
            if (modal) {
                if (modal.timerInterval) {
                    clearInterval(modal.timerInterval);
                }
                modal.remove();
            }
        }

        // é¡¯ç¤ºæˆåŠŸæ¨¡æ…‹æ¡†
        function showSuccessModal(reportUrl) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10000;';
            modal.innerHTML = `
                <div style="background:white;padding:40px;border-radius:20px;max-width:500px;width:90%;text-align:center;">
                    <h2 style="color:#38a169;font-size:32px;margin-bottom:20px;">âœ… å ±å‘Šç”ŸæˆæˆåŠŸï¼</h2>
                    <p style="color:#4a5568;margin-bottom:15px;">æ‚¨çš„å¤§å…­å£¬åˆ†æå ±å‘Šå·²ç¶“ç”Ÿæˆ</p>
                    <div style="background:#f0fff4;border:2px solid #68d391;border-radius:12px;padding:20px;margin:20px 0;word-break:break-all;font-family:monospace;font-size:14px;">
                        ${reportUrl}
                    </div>
                    <button onclick="window.open('${reportUrl}', '_blank')" style="width:100%;background:linear-gradient(135deg,#336633 0%,#2f4f4f 100%);color:white;padding:15px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:10px;">
                        ğŸ”— æ‰“é–‹å ±å‘Š
                    </button>
                    <button onclick="copyUrlAndReload('${reportUrl}')" style="width:100%;background:#3182ce;color:white;padding:15px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:10px;">
                        ğŸ“‹ è¤‡è£½éˆæ¥ä¸¦ç¹¼çºŒ
                    </button>
                    <button onclick="location.reload()" style="width:100%;background:#718096;color:white;padding:12px;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;">
                        ğŸ”„ è¿”å›ç¹¼çºŒæ’ç›¤
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function copyUrlAndReload(url) {
            navigator.clipboard.writeText(url).then(() => {
                showAlert('âœ… éˆæ¥å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
                setTimeout(() => location.reload(), 1500);
            }).catch(() => {
                showAlert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½éˆæ¥');
            });
        }

        // å¾å¾Œç«¯ç²å–å°ˆæ¥­Prompt
        async function getPromptFromBackend(liurenBriefing, question, isAutoAnalysis) {
            try {
                const response = await fetch('https://liuren-api.vercel.app/api/liuren/get-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        liurenBriefing: liurenBriefing,
                        question: question,
                        isAutoAnalysis: isAutoAnalysis
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.prompt) {
                        return data.prompt;
                    }
                }
                throw new Error('å¾Œç«¯APIè¿”å›éŒ¯èª¤');
            } catch (error) {
                console.error('å¾Œç«¯APIèª¿ç”¨å¤±æ•—:', error);
                return null;
            }
        }

        // ä¸Šå‚³å ±å‘Šåˆ°æœå‹™å™¨
        async function uploadReportToServer(htmlContent, fileName) {
            try {
                const response = await fetch(UPLOAD_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: fileName,
                        content: htmlContent
                    })
                });

                if (!response.ok) {
                    throw new Error('ä¸Šå‚³å¤±æ•—');
                }

                const result = await response.json();
                if (result.success) {
                    return result.url;
                } else {
                    throw new Error(result.error || 'ä¸Šå‚³å¤±æ•—');
                }
            } catch (error) {
                console.error('ä¸Šå‚³å ±å‘ŠéŒ¯èª¤:', error);
                throw error;
            }
        }

        // ç”Ÿæˆå ±å‘Šï¼ˆä¸»å‡½æ•°ï¼‰
        async function generateReport() {
            const question = document.getElementById('question').value.trim();
            const datetime = document.getElementById('datetime').value;

            if (!question) {
                showAlert('è«‹è¼¸å…¥è©³ç´°å å•äº‹é …ï¼');
                return;
            }

            if (!datetime) {
                showAlert('è«‹é¸æ“‡ç¾åœ¨æˆ–è‡ªé¸æ—¥æœŸæ™‚é–“ï¼');
                return;
            }

            if (remainingQuota <= 0) {
                showAlert('âŒ èµ·å¦æ¬¡æ•¸å·²ç”¨å®Œï¼Œè«‹è¿”å›é¦–é é‡æ–°è³¼è²·');
                return;
            }

            showLoading('æ­£åœ¨ç”Ÿæˆæ‚¨çš„å…­å£¬åˆ†æå ±å‘Š');

            try {
                // ç¬¬ä¸€æ­¥ï¼šèª¿ç”¨å…­å£¬è¨ˆç®—API
                const calcResponse = await fetch('https://liuren-api.vercel.app/api/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        datetime: datetime,
                        question: question
                    })
                });

                if (!calcResponse.ok) {
                    throw new Error('æ’ç›¤è¨ˆç®—å¤±æ•—');
                }

                const result = await calcResponse.json();

                if (!result.success) {
                    throw new Error(result.error || 'æ’ç›¤å¤±æ•—');
                }

                // è¨ˆç®—ç©ºäº¡
                const kongwangZhi = calculateKongwang(result.ganzhi.day);

                // ç¬¬äºŒæ­¥ï¼šæº–å‚™æ•¸æ“šçµæ§‹
                const data = {
                    basicInfo: {
                        å å•äº‹é …: question,
                        æ’ç›¤æ™‚é–“: datetime.replace('T', ' '),
                        å››æŸ±å¹²æ”¯: `${result.ganzhi.year} ${result.ganzhi.month} ${result.ganzhi.day} ${result.ganzhi.hour}`,
                        å››æŸ±å¹²æ”¯è©³ç´°: `${result.ganzhi.year} ${result.ganzhi.month} ${result.ganzhi.day} ${result.ganzhi.hour}${kongwangZhi.length > 0 ? ` (ç©ºäº¡ï¼š${kongwangZhi.join('ã€')})` : ''}`,
                        æœˆå°‡ç¯€æ°£: `${result.yuejiang.name}(${result.yuejiang.dizhi}) - ${result.yuejiang.current_jieqi}`
                    },
                    sike: [1,2,3,4].map(i => ({
                        èª²: `ç¬¬${i}èª²(${i<=2?'å¹²':'æ”¯'}èª²)`,
                        ä¸Š: result.sike[`course${i}`].up,
                        ä¸‹: result.sike[`course${i}`].down,
                        å¤©å°‡: result.sike[`course${i}`].tianjiang
                    })),
                    sanchuan: {
                        åˆå‚³: `(${result.sanchuan.chu.liuqin}ç¥)ï¼šã€${result.sanchuan.chu.ganzhi}ã€‘é…${result.sanchuan.chu.tianjiang}`,
                        ä¸­å‚³: `(${result.sanchuan.zhong.liuqin}ç¥)ï¼šã€${result.sanchuan.zhong.ganzhi}ã€‘é…${result.sanchuan.zhong.tianjiang}`,
                        æœ«å‚³: `(${result.sanchuan.mo.liuqin}ç¥)ï¼šã€${result.sanchuan.mo.ganzhi}ã€‘é…${result.sanchuan.mo.tianjiang}`
                    },
                    ketiAnalysis: {
                        èª²é«”: result.keti?.name || 'å¸¸è¦èª²é«”',
                        èª²é«”é‡‹ç¾©: result.keti?.description || 'æŒ‰ä¸€èˆ¬æ³•å‰‡åˆ†æ',
                        ç™¼ç”¨å–æ³•: result.sanchuan.method
                    }
                };

                // ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆçµæ§‹åŒ–æ•¸æ“šæ–‡æœ¬
                const structuredData = generateStructuredDataText(data, result);

                // ç¬¬å››æ­¥ï¼šèª¿ç”¨AIç²å–ç¶œåˆåˆ†æ
                const aiPrompt = await getPromptFromBackend(structuredData, question, true);

                let autoAnalysisResult = '';
                try {
                    const aiResponse = await fetch('https://poe-api-backend.vercel.app/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: aiPrompt || buildBackupPrompt(structuredData, question),
                            model: 'Claude-Sonnet-4.5'
                        })
                    });

                    if (aiResponse.ok) {
                        const aiData = await aiResponse.json();
                        const aiText = aiData.response || aiData.text || aiData.message || '';
                        autoAnalysisResult = aiText.replace(/\n/g, '<br>');
                    } else {
                        throw new Error('AIåˆ†æå¤±æ•—');
                    }
                } catch (error) {
                    autoAnalysisResult = `<div style="color:red;border:1px solid red;padding:10px;border-radius:5px;"><h4>âŒ è‡ªå‹•åˆ†æå¤±æ•—</h4><p>åŸå› ï¼š${error.message}</p></div>`;
                }

                // ç¬¬äº”æ­¥ï¼šç”ŸæˆHTMLå ±å‘Š
                const reportHTML = generateClientReportHTML(data, result, autoAnalysisResult, kongwangZhi);

                // ç¬¬å…­æ­¥ï¼šç”Ÿæˆæ–‡ä»¶åä¸¦ä¸Šå‚³åˆ°æœå‹™å™¨
                const reportId = generateSimpleSecureId();
                const timestamp = new Date().toISOString().slice(0,16).replace(/[-:T]/g, '');
                const fileName = `${reportId}_${timestamp}.html`;

                // ä¸Šå‚³åˆ°æœå‹™å™¨
const reportUrl = await uploadReportToServer(reportHTML, fileName);

// âœ… å ±å‘ŠæˆåŠŸç”Ÿæˆä¸¦ä¸Šå‚³å¾Œï¼Œæ‰æ‰£é™¤é…é¡
try {
    const deductResponse = await fetch('/api/use-quota', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: currentAccessCode })
    });

    const deductResult = await deductResponse.json();

    if (deductResult.success) {
        // æ›´æ–°å‰©ä½™æ¬¡æ•°
        remainingQuota = deductResult.remaining;
        updateQuotaBanner();
    } else {
        console.warn('é…é¡æ‰£é™¤å¤±æ•—ï¼Œä½†å ±å‘Šå·²ç”Ÿæˆ:', deductResult.error);
    }
} catch (quotaError) {
    console.warn('é…é¡æ‰£é™¤è«‹æ±‚å¤±æ•—ï¼Œä½†å ±å‘Šå·²ç”Ÿæˆ:', quotaError);
}

hideLoading();

// é¡¯ç¤ºæˆåŠŸæ¨¡æ…‹æ¡†
showSuccessModal(reportUrl);

            } catch (error) {
                hideLoading();
                showAlert('âŒ ç”Ÿæˆå¤±æ•—ï¼š' + error.message);
                console.error('ç”Ÿæˆå ±å‘ŠéŒ¯èª¤:', error);
            }
        }

        // ç”Ÿæˆçµæ§‹åŒ–æ•¸æ“šæ–‡æœ¬
        function generateStructuredDataText(data, result) {
            let output = '=== å¤§å…­å£¬å°ˆæ¥­åˆ†ææ•¸æ“šåŒ… ===\n\n';

            output += 'ã€ç¬¬ä¸€å±¤ï¼šæ™‚ç©ºåŸºç¤ã€‘\n';
            output += `å å•äº‹é …ï¼š${data.basicInfo.å å•äº‹é …}\n`;
            output += `æ’ç›¤æ™‚é–“ï¼š${data.basicInfo.æ’ç›¤æ™‚é–“}\n`;
            output += `å››æŸ±å¹²æ”¯ï¼š${data.basicInfo.å››æŸ±å¹²æ”¯è©³ç´°}\n`;
            output += `æœˆå°‡ç¯€æ°£ï¼š${data.basicInfo.æœˆå°‡ç¯€æ°£}\n\n`;

            output += 'ã€ç¬¬äºŒå±¤ï¼šèª²å¼æ ¸å¿ƒã€‘\n';
            output += 'å››èª²è©³ç´°é…ç½®ï¼š\n';
            data.sike.forEach((course, i) => {
                output += `ç¬¬${i+1}èª²ï¼ˆ${i<2?'æ—¥å¹²èª²':'æ—¥æ”¯èª²'}ï¼‰\n`;
                output += `    â”Œâ”€ ä¸Šç¥ï¼š${course.ä¸Š}\n`;
                output += `    â”œâ”€ ä¸‹ç¥ï¼š${course.ä¸‹}\n`;
                output += `    â””â”€ å¤©å°‡ï¼š${course.å¤©å°‡}\n\n`;
            });

            output += 'ä¸‰å‚³æµè½‰ï¼š\n';
            output += `- åˆå‚³ï¼š${data.sanchuan.åˆå‚³}\n`;
            output += `- ä¸­å‚³ï¼š${data.sanchuan.ä¸­å‚³}\n`;
            output += `- æœ«å‚³ï¼š${data.sanchuan.æœ«å‚³}\n\n`;

            output += 'èª²é«”è¨ºæ–·ï¼š\n';
            output += `èª²é«”ï¼š${data.ketiAnalysis.èª²é«”}\n`;
            output += `ç™¼ç”¨å–æ³•ï¼š${data.ketiAnalysis.ç™¼ç”¨å–æ³•}\n\n`;

            return output;
        }

        // å‚™ç”¨Prompt
        function buildBackupPrompt(structuredData, question) {
            return `ä½ æ˜¯ Victor AI å…­å£¬æ™ºæ…§åŠ©æ‰‹ã€‚è«‹æ ¹æ“šä»¥ä¸‹ç›¤å¼è³‡æ–™é€²è¡Œå°ˆæ¥­å…­å£¬åˆ†æã€‚

ã€å å•äº‹é …ã€‘${question}

ã€ç›¤å¼è³‡æ–™ã€‘
${structuredData}

è«‹æ ¹æ“šå…­å£¬åŸç†é€²è¡Œå°ˆæ¥­åˆ†æï¼Œçµ¦å‡ºæ˜ç¢ºçš„å‰å‡¶åˆ¤æ–·å’Œå»ºè­°ã€‚`;
        }

        // ç”Ÿæˆå ±å‘ŠID
        function generateSimpleSecureId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const timestamp = Date.now().toString(36).slice(-6);
            let randomPart = '';
            for (let i = 0; i < 4; i++) {
                randomPart += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return `LR${timestamp}${randomPart}`;
        }

        // è¨ˆç®—ç©ºäº¡
        function calculateKongwang(dayGanzhi) {
            const KONGWANG_MAP = {
                'ç”²å­': ['æˆŒ', 'äº¥'], 'ä¹™ä¸‘': ['æˆŒ', 'äº¥'], 'ä¸™å¯…': ['æˆŒ', 'äº¥'], 'ä¸å¯': ['æˆŒ', 'äº¥'],
                'æˆŠè¾°': ['æˆŒ', 'äº¥'], 'å·±å·³': ['æˆŒ', 'äº¥'], 'åºšåˆ': ['æˆŒ', 'äº¥'], 'è¾›æœª': ['æˆŒ', 'äº¥'],
                'å£¬ç”³': ['æˆŒ', 'äº¥'], 'ç™¸é…‰': ['æˆŒ', 'äº¥'], 'ç”²æˆŒ': ['ç”³', 'é…‰'], 'ä¹™äº¥': ['ç”³', 'é…‰'],
                'ä¸™å­': ['ç”³', 'é…‰'], 'ä¸ä¸‘': ['ç”³', 'é…‰'], 'æˆŠå¯…': ['ç”³', 'é…‰'], 'å·±å¯': ['ç”³', 'é…‰'],
                'åºšè¾°': ['ç”³', 'é…‰'], 'è¾›å·³': ['ç”³', 'é…‰'], 'å£¬åˆ': ['ç”³', 'é…‰'], 'ç™¸æœª': ['ç”³', 'é…‰'],
                'ç”²ç”³': ['åˆ', 'æœª'], 'ä¹™é…‰': ['åˆ', 'æœª'], 'ä¸™æˆŒ': ['åˆ', 'æœª'], 'ä¸äº¥': ['åˆ', 'æœª'],
                'æˆŠå­': ['åˆ', 'æœª'], 'å·±ä¸‘': ['åˆ', 'æœª'], 'åºšå¯…': ['åˆ', 'æœª'], 'è¾›å¯': ['åˆ', 'æœª'],
                'å£¬è¾°': ['åˆ', 'æœª'], 'ç™¸å·³': ['åˆ', 'æœª'], 'ç”²åˆ': ['è¾°', 'å·³'], 'ä¹™æœª': ['è¾°', 'å·³'],
                'ä¸™ç”³': ['è¾°', 'å·³'], 'ä¸é…‰': ['è¾°', 'å·³'], 'æˆŠæˆŒ': ['è¾°', 'å·³'], 'å·±äº¥': ['è¾°', 'å·³'],
                'åºšå­': ['è¾°', 'å·³'], 'è¾›ä¸‘': ['è¾°', 'å·³'], 'å£¬å¯…': ['è¾°', 'å·³'], 'ç™¸å¯': ['è¾°', 'å·³'],
                'ç”²è¾°': ['å¯…', 'å¯'], 'ä¹™å·³': ['å¯…', 'å¯'], 'ä¸™åˆ': ['å¯…', 'å¯'], 'ä¸æœª': ['å¯…', 'å¯'],
                'æˆŠç”³': ['å¯…', 'å¯'], 'å·±é…‰': ['å¯…', 'å¯'], 'åºšæˆŒ': ['å¯…', 'å¯'], 'è¾›äº¥': ['å¯…', 'å¯'],
                'å£¬å­': ['å¯…', 'å¯'], 'ç™¸ä¸‘': ['å¯…', 'å¯'], 'ç”²å¯…': ['å­', 'ä¸‘'], 'ä¹™å¯': ['å­', 'ä¸‘'],
                'ä¸™è¾°': ['å­', 'ä¸‘'], 'ä¸å·³': ['å­', 'ä¸‘'], 'æˆŠåˆ': ['å­', 'ä¸‘'], 'å·±æœª': ['å­', 'ä¸‘'],
                'åºšç”³': ['å­', 'ä¸‘'], 'è¾›é…‰': ['å­', 'ä¸‘'], 'å£¬æˆŒ': ['å­', 'ä¸‘'], 'ç™¸äº¥': ['å­', 'ä¸‘']
            };
            return KONGWANG_MAP[dayGanzhi] || [];
        }

        // ç”Ÿæˆå®¢æˆ¶å ±å‘ŠHTMLï¼ˆä½¿ç”¨ä½ åŸç¨‹åºçš„å®Œæ•´å‡½æ•° - è¿™é‡Œç®€åŒ–æ˜¾ç¤ºï¼‰
        function generateClientReportHTML(data, result, autoAnalysisResult, kongwangZhi) {
            const tianpanData = result.tianpan.positions;
            const tianjiangData = result.tianjiang.positions;
            const kongwangInfo = {
                dayGanzhi: result.ganzhi.day,
                kongwangZhi: kongwangZhi
            };
            const chatHistoryJSON = JSON.stringify([]);
            const clientJS = generateClientJS(data, tianpanData, tianjiangData, kongwangInfo, chatHistoryJSON);
            const clientHTML = generateClientHTML(data, autoAnalysisResult, clientJS);
            return clientHTML;
        }

        // è¿™é‡Œéœ€è¦åŒ…å«ä½ åŸç¨‹åºçš„ generateClientJS å’Œ generateClientHTML å‡½æ•°
        // ç”±äºå¤ªé•¿ï¼Œæˆ‘ä¼šåœ¨ä¸‹ä¸€ä¸ªæ–‡ä»¶ä¸­åˆ›å»º
        function generateClientJS(data, tianpanData, tianjiangData, kongwangInfo, chatHistoryJSON) {
            // ç®€åŒ–ç‰ˆæœ¬ - å®é™…åº”è¯¥ä½¿ç”¨ä½ åŸç¨‹åºçš„å®Œæ•´ä»£ç 
            return `console.log('Report loaded');`;
        }

        function generateClientHTML(data, autoAnalysisResult, clientJS) {
            // ç®€åŒ–ç‰ˆæœ¬ - å®é™…åº”è¯¥ä½¿ç”¨ä½ åŸç¨‹åºçš„å®Œæ•´ä»£ç 
            return '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>å ±å‘Š</title></head><body><h1>å ±å‘Šç”ŸæˆæˆåŠŸ</h1><p>' + autoAnalysisResult + '</p><script>' + clientJS + '<' + '/script></body></html>';
        }
    </script>
</body>
</html>
