<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å…­å£¬æ™ºæ…§æ’ç›¤ - Victor AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', Arial, "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .main-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            overflow: hidden;
            position: relative;
        }

        .taichi-bg {
            position: absolute;
            width: 140px;
            height: 140px;
            background-image: url('https://victorlau.myqnapcloud.com/taichi.webp');
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 0.15;
            z-index: 1;
            animation: rotate 20s linear infinite;
            pointer-events: none;
        }
        .taichi-bg.left {
            top: -30px;
            left: -30px;
        }
        .taichi-bg.right {
            bottom: -30px;
            right: -30px;
        }
        .bagua-bg {
            position: absolute;
            bottom: -120px;
            right: -120px;
            width: 300px;
            height: 300px;
            background-image: url('https://victorlau.myqnapcloud.com/taichi.webp');
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 0.03;
            z-index: 0;
            animation: slowRotate 80s linear infinite reverse;
            pointer-events: none;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes slowRotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .header {
            background: linear-gradient(120deg, #336633, #2f4f4f);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('https://victorlau.myqnapcloud.com/taichi.webp');
            background-repeat: no-repeat;
            background-position: right center;
            background-size: 200px;
            opacity: 0.1;
            z-index: 0;
            animation: pulse 8s infinite ease-in-out;
        }

        .header h1,
        .header p {
            position: relative;
            z-index: 2;
        }

        .quota-banner {
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
            border: 2px solid #68d391;
            border-radius: 15px;
            padding: 15px 20px;
            margin: 20px 30px;
            text-align: center;
            position: relative;
            z-index: 2;
        }

        .quota-banner.warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
        }

        .quota-banner.empty {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: #f87171;
        }

        .content {
            padding: 30px;
            position: relative;
            z-index: 2;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #336633;
            box-shadow: 0 0 0 3px rgba(51,102,51,0.1);
        }

        .generate-btn {
            width: 100%;
            background: linear-gradient(135deg, #336633 0%, #2f4f4f 100%);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(51,102,51,0.3);
        }

        .generate-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .loading-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #336633;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            margin-top: 20px;
            color: #718096;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .taichi-bg {
                width: 80px;
                height: 80px;
            }
            .bagua-bg {
                width: 200px;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="main-card">
        <div class="bagua-bg"></div>

        <div class="header">
            <div class="taichi-bg left"></div>
            <div class="taichi-bg right"></div>

            <h1 style="font-size: 28px; margin-bottom: 10px;">ğŸ§® å¤§å…­å£¬æ™ºæ…§æ’ç›¤</h1>
            <p style="opacity: 0.9;">Victor AI ä¸»ç†</p>
        </div>

        <!-- å‰©ä½™æ¬¡æ•°æ¨ªå¹… -->
        <div id="quota-banner" class="quota-banner" style="display:none;">
            <p id="quota-text" style="font-weight: 600; font-size: 16px; margin: 0;"></p>
        </div>

        <div class="content">
            <div class="input-group">
                <label for="question">ğŸ“ å å•äº‹é …</label>
                <textarea
                    id="question"
                    rows="3"
                    placeholder="è«‹è¼¸å…¥æ‚¨æƒ³è¦å å•çš„äº‹æƒ…ï¼Œä¾‹å¦‚ï¼šå•ä»Šæ—¥è²¡é‹å¦‚ä½•ï¼Ÿ"
                    required
                ></textarea>
            </div>

            <div class="input-group">
                <label for="datetime">ğŸ“… é¸æ“‡ç¾åœ¨æˆ–è‡ªé¸æ—¥æœŸæ™‚é–“</label>
                <input
                    type="datetime-local"
                    id="datetime"
                    required
                >
            </div>

            <button class="generate-btn" onclick="generateReport()">
                ğŸ¯ é–‹å§‹æ’ç›¤èˆ‡åˆ†æ
            </button>

            <div class="footer">
                Â© 2025 Victor AI ä¸»ç† Â· åƒ…ä¾›åƒè€ƒ
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentAccessCode = '';
        let remainingQuota = 0;

        // ä¸Šå‚³API URL
        const UPLOAD_API_URL = 'https://victorlau.myqnapcloud.com/upload-report.php';

        // é¡µé¢åŠ è½½æ—¶éªŒè¯èµ·å¦ç 
        window.addEventListener('DOMContentLoaded', async function() {
            setCurrentTime();
            await verifyAccessCode();
        });

        // ä» URL å‚æ•°è·å–èµ·å¦ç 
        function getAccessCodeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('code');
        }

        // éªŒè¯èµ·å¦ç 
        async function verifyAccessCode() {
            const code = getAccessCodeFromURL();

            if (!code) {
                showAlert('âš ï¸ æœªæ‰¾åˆ°èµ·å¦ç¢¼ï¼Œè«‹è¿”å›é¦–é é‡æ–°è¼¸å…¥');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
                return;
            }

            try {
                const response = await fetch('/api/check-quota', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: code.toUpperCase() })
                });

                const result = await response.json();

                if (!result.success) {
                    showAlert('âŒ ' + (result.error || 'èµ·å¦ç¢¼ç„¡æ•ˆ'));
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                    return;
                }

                // ä¿å­˜èµ·å¦ç å’Œå‰©ä½™æ¬¡æ•°
                currentAccessCode = code.toUpperCase();
                remainingQuota = result.remaining;

                // æ˜¾ç¤ºå‰©ä½™æ¬¡æ•°
                updateQuotaBanner();

                if (remainingQuota <= 0) {
                    showAlert('âš ï¸ æ­¤èµ·å¦ç¢¼å·²ç”¨å®Œæ‰€æœ‰æ¬¡æ•¸ï¼Œè«‹è¿”å›é¦–é é‡æ–°è³¼è²·');
                    document.querySelector('.generate-btn').disabled = true;
                }

            } catch (error) {
                showAlert('âŒ é©—è­‰å¤±æ•—ï¼š' + error.message);
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
        }

        // æ›´æ–°å‰©ä½™æ¬¡æ•°æ¨ªå¹…
        function updateQuotaBanner() {
            const banner = document.getElementById('quota-banner');
            const text = document.getElementById('quota-text');

            banner.style.display = 'block';

            if (remainingQuota === 0) {
                banner.className = 'quota-banner empty';
                text.innerHTML = 'âŒ å‰©é¤˜æ¬¡æ•¸ï¼š0 æ¬¡ - è«‹è¿”å›é¦–é é‡æ–°è³¼è²·';
            } else if (remainingQuota === 1) {
                banner.className = 'quota-banner warning';
                text.innerHTML = 'âš ï¸ å‰©é¤˜æ¬¡æ•¸ï¼š1 æ¬¡ - å³å°‡ç”¨å®Œ';
            } else {
                banner.className = 'quota-banner';
                text.innerHTML = `âœ… å‰©é¤˜æ¬¡æ•¸ï¼š${remainingQuota} æ¬¡`;
            }
        }

        // è¨­ç½®ç•¶å‰æ™‚é–“
        function setCurrentTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('datetime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // è‡ªå®šä¹‰ Alert å‡½æ•°
        function showAlert(message) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;';
            modal.innerHTML = `
                <div style="background:white;padding:30px;border-radius:15px;max-width:400px;width:90%;box-shadow:0 10px 30px rgba(0,0,0,0.3);">
                    <p style="color:#2d3748;margin-bottom:20px;font-size:16px;line-height:1.6;">${message}</p>
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="width:100%;background:#336633;color:white;padding:12px;border:none;border-radius:8px;cursor:pointer;font-size:16px;font-weight:600;">ç¢ºå®š</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // é¡¯ç¤ºåŠ è¼‰å‹•ç•«
        function showLoading(message) {
            const modal = document.createElement('div');
            modal.id = 'loading-modal';
            modal.className = 'loading-modal';
            modal.innerHTML = `
                <div class="loading-content">
                    <div class="spinner"></div>
                    <h3 style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">${message}</h3>
                    <p id="loading-status" style="color: #718096; font-size: 14px;">æ­£åœ¨æº–å‚™...</p>
                    <p style="margin-top: 15px; color: #718096; font-size: 12px;">
                        å·²ç”¨æ™‚ï¼š<span id="timer" style="font-family: monospace;">00:00</span>
                    </p>
                </div>
            `;
            document.body.appendChild(modal);

            // å•Ÿå‹•è¨ˆæ™‚å™¨
            const startTime = Date.now();
            const timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                const timerEl = document.getElementById('timer');
                const statusEl = document.getElementById('loading-status');

                if (timerEl) {
                    timerEl.textContent = timeString;
                }

                if (statusEl) {
                    let statusMessage = '';
                    let subMessage = '';
                    let progress = 0;

                    if (elapsed < 5) {
                        statusMessage = 'âš™ï¸ æ­£åœ¨æº–å‚™ç›¤å¼è³‡æ–™';
                        progress = 2;
                    } else if (elapsed < 10) {
                        statusMessage = 'ğŸ§® æ­£åœ¨è¨ˆç®—å››æŸ±èˆ‡æœˆå°‡';
                        progress = 5;
                    } else if (elapsed < 20) {
                        statusMessage = 'ğŸ“Š æ­£åœ¨æ’å®šå¤©ç›¤åœ°ç›¤èˆ‡å››èª²';
                        progress = 10;
                    } else if (elapsed < 30) {
                        statusMessage = 'ğŸ¯ æ­£åœ¨æ¨ç®—ä¸‰å‚³èˆ‡èª²é«”';
                        progress = 15;
                    } else if (elapsed < 45) {
                        statusMessage = 'ğŸ¤– æ­£åœ¨å•Ÿå‹• Victor AI å°ˆæ¥­åˆ†æç³»çµ±';
                        subMessage = 'å…­å£¬æ™ºæ…§å¼•æ“æº–å‚™ä¸­...';
                        progress = 20;
                    } else if (elapsed < 90) {
                        statusMessage = 'ğŸ§  AI æ­£åœ¨æ·±åº¦åˆ†æèª²å¼';
                        subMessage = 'é è¨ˆéœ€æ™‚ 3-4 åˆ†é˜ï¼Œæ­£åœ¨åˆ†æå¤©å°‡èˆ‡ç¥ç…é…ç½®...';
                        progress = 20 + Math.floor(((elapsed - 45) / 45) * 30);
                    } else if (elapsed < 150) {
                        statusMessage = 'ğŸ“ AI æ­£åœ¨æ•´åˆå…­è¦ªèˆ‡å‰å‡¶åˆ¤æ–·';
                        subMessage = 'æ­£åœ¨åƒè€ƒå¤ç±ç†è«–èˆ‡ç¾ä»£æ‡‰ç”¨...';
                        progress = 50 + Math.floor(((elapsed - 90) / 60) * 25);
                    } else if (elapsed < 210) {
                        statusMessage = 'âœ¨ AI æ­£åœ¨ç”Ÿæˆå°ˆæ¥­åˆ†æå ±å‘Š';
                        subMessage = 'å³å°‡å®Œæˆï¼Œæ„Ÿè¬æ‚¨çš„è€å¿ƒç­‰å¾…...';
                        progress = 75 + Math.floor(((elapsed - 150) / 60) * 20);
                    } else if (elapsed < 240) {
                        statusMessage = 'ğŸ“¤ æ­£åœ¨ä¸Šå‚³å ±å‘Šåˆ°æœå‹™å™¨';
                        progress = 95;
                    } else {
                        statusMessage = 'ğŸ‰ å³å°‡å®Œæˆ';
                        progress = 99;
                    }

                    statusEl.innerHTML = `
                        <div style="font-size: 14px; margin-bottom: 8px;">${statusMessage}</div>
                        ${subMessage ? `<div style="font-size: 12px; color: #718096; margin-bottom: 10px;">${subMessage}</div>` : ''}
                        <div style="background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 10px;">
                            <div style="background: linear-gradient(90deg, #336633, #5D5CDE); height: 100%; width: ${progress}%; transition: width 0.5s ease;"></div>
                        </div>
                        <div style="font-size: 11px; color: #5D5CDE; font-weight: 600; margin-top: 5px;">${progress}%</div>
                    `;
                }
            }, 1000);

            modal.timerInterval = timerInterval;
        }

        function hideLoading() {
            const modal = document.getElementById('loading-modal');
            if (modal) {
                if (modal.timerInterval) {
                    clearInterval(modal.timerInterval);
                }
                modal.remove();
            }
        }

        // é¡¯ç¤ºæˆåŠŸæ¨¡æ…‹æ¡†
        function showSuccessModal(reportUrl) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10000;';
            modal.innerHTML = `
                <div style="background:white;padding:40px;border-radius:20px;max-width:500px;width:90%;text-align:center;">
                    <h2 style="color:#38a169;font-size:32px;margin-bottom:20px;">âœ… å ±å‘Šç”ŸæˆæˆåŠŸï¼</h2>
                    <p style="color:#4a5568;margin-bottom:15px;">æ‚¨çš„å¤§å…­å£¬åˆ†æå ±å‘Šå·²ç¶“ç”Ÿæˆ</p>
                    <div style="background:#f0fff4;border:2px solid #68d391;border-radius:12px;padding:20px;margin:20px 0;word-break:break-all;font-family:monospace;font-size:14px;">
                        ${reportUrl}
                    </div>
                    <button onclick="window.open('${reportUrl}', '_blank')" style="width:100%;background:linear-gradient(135deg,#336633 0%,#2f4f4f 100%);color:white;padding:15px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:10px;">
                        ğŸ”— æ‰“é–‹å ±å‘Š
                    </button>
                    <button onclick="copyUrlAndReload('${reportUrl}')" style="width:100%;background:#3182ce;color:white;padding:15px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:10px;">
                        ğŸ“‹ è¤‡è£½éˆæ¥ä¸¦ç¹¼çºŒ
                    </button>
                    <button onclick="location.reload()" style="width:100%;background:#718096;color:white;padding:12px;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;">
                        ğŸ”„ è¿”å›ç¹¼çºŒæ’ç›¤
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function copyUrlAndReload(url) {
            navigator.clipboard.writeText(url).then(() => {
                showAlert('âœ… éˆæ¥å·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼');
                setTimeout(() => location.reload(), 1500);
            }).catch(() => {
                showAlert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½éˆæ¥');
            });
        }

        // å¾å¾Œç«¯ç²å–å°ˆæ¥­Prompt
        async function getPromptFromBackend(liurenBriefing, question, isAutoAnalysis) {
            try {
                const response = await fetch('https://liuren-api.vercel.app/api/liuren/get-prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        liurenBriefing: liurenBriefing,
                        question: question,
                        isAutoAnalysis: isAutoAnalysis
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.prompt) {
                        return data.prompt;
                    }
                }
                throw new Error('å¾Œç«¯APIè¿”å›éŒ¯èª¤');
            } catch (error) {
                console.error('å¾Œç«¯APIèª¿ç”¨å¤±æ•—:', error);
                return null;
            }
        }

        // ä¸Šå‚³å ±å‘Šåˆ°æœå‹™å™¨
        async function uploadReportToServer(htmlContent, fileName) {
            try {
                const response = await fetch(UPLOAD_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: fileName,
                        content: htmlContent
                    })
                });

                if (!response.ok) {
                    throw new Error('ä¸Šå‚³å¤±æ•—');
                }

                const result = await response.json();
                if (result.success) {
                    return result.url;
                } else {
                    throw new Error(result.error || 'ä¸Šå‚³å¤±æ•—');
                }
            } catch (error) {
                console.error('ä¸Šå‚³å ±å‘ŠéŒ¯èª¤:', error);
                throw error;
            }
        }

        // ç”Ÿæˆå ±å‘Šï¼ˆä¸»å‡½æ•°ï¼‰
        async function generateReport() {
            const question = document.getElementById('question').value.trim();
            const datetime = document.getElementById('datetime').value;

            if (!question) {
                showAlert('è«‹è¼¸å…¥è©³ç´°å å•äº‹é …ï¼');
                return;
            }

            if (!datetime) {
                showAlert('è«‹é¸æ“‡ç¾åœ¨æˆ–è‡ªé¸æ—¥æœŸæ™‚é–“ï¼');
                return;
            }

            if (remainingQuota <= 0) {
                showAlert('âŒ èµ·å¦æ¬¡æ•¸å·²ç”¨å®Œï¼Œè«‹è¿”å›é¦–é é‡æ–°è³¼è²·');
                return;
            }

            showLoading('æ­£åœ¨ç”Ÿæˆæ‚¨çš„å…­å£¬åˆ†æå ±å‘Š');

            try {
                // ç¬¬ä¸€æ­¥ï¼šèª¿ç”¨å…­å£¬è¨ˆç®—API
let calcResponse;
try {
    calcResponse = await fetch('https://liuren-api.vercel.app/api/calculate', {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({
            datetime: datetime,
            question: question
        }),
        mode: 'cors'
    });
} catch (fetchError) {
    console.error('ç¶²çµ¡è«‹æ±‚å¤±æ•—:', fetchError);
    throw new Error('ç„¡æ³•é€£æ¥åˆ°å…­å£¬è¨ˆç®—æœå‹™å™¨ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£æ¥æˆ–ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤è©³æƒ…: ' + fetchError.message);
}

if (!calcResponse.ok) {
    const errorText = await calcResponse.text();
    console.error('API éŒ¯èª¤å›æ‡‰:', errorText);
    throw new Error('æ’ç›¤è¨ˆç®—å¤±æ•— (HTTP ' + calcResponse.status + ')');
}
                const result = await calcResponse.json();

                if (!result.success) {
                    throw new Error(result.error || 'æ’ç›¤å¤±æ•—');
                }

                // è¨ˆç®—ç©ºäº¡
                const kongwangZhi = calculateKongwang(result.ganzhi.day);

                // ç¬¬äºŒæ­¥ï¼šæº–å‚™æ•¸æ“šçµæ§‹
                const data = {
                    basicInfo: {
                        å å•äº‹é …: question,
                        æ’ç›¤æ™‚é–“: datetime.replace('T', ' '),
                        å››æŸ±å¹²æ”¯: `${result.ganzhi.year} ${result.ganzhi.month} ${result.ganzhi.day} ${result.ganzhi.hour}`,
                        å››æŸ±å¹²æ”¯è©³ç´°: `${result.ganzhi.year} ${result.ganzhi.month} ${result.ganzhi.day} ${result.ganzhi.hour}${kongwangZhi.length > 0 ? ` (ç©ºäº¡ï¼š${kongwangZhi.join('ã€')})` : ''}`,
                        æœˆå°‡ç¯€æ°£: `${result.yuejiang.name}(${result.yuejiang.dizhi}) - ${result.yuejiang.current_jieqi}`
                    },
                    sike: [1,2,3,4].map(i => ({
                        èª²: `ç¬¬${i}èª²(${i<=2?'å¹²':'æ”¯'}èª²)`,
                        ä¸Š: result.sike[`course${i}`].up,
                        ä¸‹: result.sike[`course${i}`].down,
                        å¤©å°‡: result.sike[`course${i}`].tianjiang
                    })),
                    sanchuan: {
                        åˆå‚³: `(${result.sanchuan.chu.liuqin}ç¥)ï¼šã€${result.sanchuan.chu.ganzhi}ã€‘é…${result.sanchuan.chu.tianjiang}`,
                        ä¸­å‚³: `(${result.sanchuan.zhong.liuqin}ç¥)ï¼šã€${result.sanchuan.zhong.ganzhi}ã€‘é…${result.sanchuan.zhong.tianjiang}`,
                        æœ«å‚³: `(${result.sanchuan.mo.liuqin}ç¥)ï¼šã€${result.sanchuan.mo.ganzhi}ã€‘é…${result.sanchuan.mo.tianjiang}`
                    },
                    ketiAnalysis: {
                        èª²é«”: result.keti?.name || 'å¸¸è¦èª²é«”',
                        èª²é«”é‡‹ç¾©: result.keti?.description || 'æŒ‰ä¸€èˆ¬æ³•å‰‡åˆ†æ',
                        ç™¼ç”¨å–æ³•: result.sanchuan.method
                    }
                };

                // ç¬¬ä¸‰æ­¥ï¼šç”Ÿæˆçµæ§‹åŒ–æ•¸æ“šæ–‡æœ¬
                const structuredData = generateStructuredDataText(data, result);

                // ç¬¬å››æ­¥ï¼šèª¿ç”¨AIç²å–ç¶œåˆåˆ†æ
                const aiPrompt = await getPromptFromBackend(structuredData, question, true);

                let autoAnalysisResult = '';
                try {
                    const aiResponse = await fetch('https://poe-api-backend.vercel.app/api/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message: aiPrompt || buildBackupPrompt(structuredData, question),
                            model: 'Claude-Sonnet-4.5'
                        })
                    });

                    if (aiResponse.ok) {
                        const aiData = await aiResponse.json();
                        const aiText = aiData.response || aiData.text || aiData.message || '';
                        autoAnalysisResult = aiText.replace(/\n/g, '<br>');
                    } else {
                        throw new Error('AIåˆ†æå¤±æ•—');
                    }
                } catch (error) {
                    autoAnalysisResult = `<div style="color:red;border:1px solid red;padding:10px;border-radius:5px;"><h4>âŒ è‡ªå‹•åˆ†æå¤±æ•—</h4><p>åŸå› ï¼š${error.message}</p></div>`;
                }

                // ç¬¬äº”æ­¥ï¼šç”ŸæˆHTMLå ±å‘Š
                const reportHTML = generateClientReportHTML(data, result, autoAnalysisResult, kongwangZhi);

                // ç¬¬å…­æ­¥ï¼šç”Ÿæˆæ–‡ä»¶åä¸¦ä¸Šå‚³åˆ°æœå‹™å™¨
                const reportId = generateSimpleSecureId();
                const timestamp = new Date().toISOString().slice(0,16).replace(/[-:T]/g, '');
                const fileName = `${reportId}_${timestamp}.html`;

                // ä¸Šå‚³åˆ°æœå‹™å™¨
const reportUrl = await uploadReportToServer(reportHTML, fileName);

// âœ… å ±å‘ŠæˆåŠŸç”Ÿæˆä¸¦ä¸Šå‚³å¾Œï¼Œæ‰æ‰£é™¤é…é¡
try {
    const deductResponse = await fetch('/api/use-quota', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ code: currentAccessCode })
    });

    const deductResult = await deductResponse.json();

    if (deductResult.success) {
        // æ›´æ–°å‰©ä½™æ¬¡æ•°
        remainingQuota = deductResult.remaining;
        updateQuotaBanner();
    } else {
        console.warn('é…é¡æ‰£é™¤å¤±æ•—ï¼Œä½†å ±å‘Šå·²ç”Ÿæˆ:', deductResult.error);
    }
} catch (quotaError) {
    console.warn('é…é¡æ‰£é™¤è«‹æ±‚å¤±æ•—ï¼Œä½†å ±å‘Šå·²ç”Ÿæˆ:', quotaError);
}

hideLoading();

// é¡¯ç¤ºæˆåŠŸæ¨¡æ…‹æ¡†
showSuccessModal(reportUrl);

            } catch (error) {
                hideLoading();
                showAlert('âŒ ç”Ÿæˆå¤±æ•—ï¼š' + error.message);
                console.error('ç”Ÿæˆå ±å‘ŠéŒ¯èª¤:', error);
            }
        }

        // ç”Ÿæˆçµæ§‹åŒ–æ•¸æ“šæ–‡æœ¬
        function generateStructuredDataText(data, result) {
            let output = '=== å¤§å…­å£¬å°ˆæ¥­åˆ†ææ•¸æ“šåŒ… ===\n\n';

            output += 'ã€ç¬¬ä¸€å±¤ï¼šæ™‚ç©ºåŸºç¤ã€‘\n';
            output += `å å•äº‹é …ï¼š${data.basicInfo.å å•äº‹é …}\n`;
            output += `æ’ç›¤æ™‚é–“ï¼š${data.basicInfo.æ’ç›¤æ™‚é–“}\n`;
            output += `å››æŸ±å¹²æ”¯ï¼š${data.basicInfo.å››æŸ±å¹²æ”¯è©³ç´°}\n`;
            output += `æœˆå°‡ç¯€æ°£ï¼š${data.basicInfo.æœˆå°‡ç¯€æ°£}\n\n`;

            output += 'ã€ç¬¬äºŒå±¤ï¼šèª²å¼æ ¸å¿ƒã€‘\n';
            output += 'å››èª²è©³ç´°é…ç½®ï¼š\n';
            data.sike.forEach((course, i) => {
                output += `ç¬¬${i+1}èª²ï¼ˆ${i<2?'æ—¥å¹²èª²':'æ—¥æ”¯èª²'}ï¼‰\n`;
                output += `    â”Œâ”€ ä¸Šç¥ï¼š${course.ä¸Š}\n`;
                output += `    â”œâ”€ ä¸‹ç¥ï¼š${course.ä¸‹}\n`;
                output += `    â””â”€ å¤©å°‡ï¼š${course.å¤©å°‡}\n\n`;
            });

            output += 'ä¸‰å‚³æµè½‰ï¼š\n';
            output += `- åˆå‚³ï¼š${data.sanchuan.åˆå‚³}\n`;
            output += `- ä¸­å‚³ï¼š${data.sanchuan.ä¸­å‚³}\n`;
            output += `- æœ«å‚³ï¼š${data.sanchuan.æœ«å‚³}\n\n`;

            output += 'èª²é«”è¨ºæ–·ï¼š\n';
            output += `èª²é«”ï¼š${data.ketiAnalysis.èª²é«”}\n`;
            output += `ç™¼ç”¨å–æ³•ï¼š${data.ketiAnalysis.ç™¼ç”¨å–æ³•}\n\n`;

            return output;
        }

        // å‚™ç”¨Prompt
        function buildBackupPrompt(structuredData, question) {
            return `ä½ æ˜¯ Victor AI å…­å£¬æ™ºæ…§åŠ©æ‰‹ã€‚è«‹æ ¹æ“šä»¥ä¸‹ç›¤å¼è³‡æ–™é€²è¡Œå°ˆæ¥­å…­å£¬åˆ†æã€‚

ã€å å•äº‹é …ã€‘${question}

ã€ç›¤å¼è³‡æ–™ã€‘
${structuredData}

è«‹æ ¹æ“šå…­å£¬åŸç†é€²è¡Œå°ˆæ¥­åˆ†æï¼Œçµ¦å‡ºæ˜ç¢ºçš„å‰å‡¶åˆ¤æ–·å’Œå»ºè­°ã€‚`;
        }

        // ç”Ÿæˆå ±å‘ŠID
        function generateSimpleSecureId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const timestamp = Date.now().toString(36).slice(-6);
            let randomPart = '';
            for (let i = 0; i < 4; i++) {
                randomPart += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return `LR${timestamp}${randomPart}`;
        }

        // è¨ˆç®—ç©ºäº¡
        function calculateKongwang(dayGanzhi) {
            const KONGWANG_MAP = {
                'ç”²å­': ['æˆŒ', 'äº¥'], 'ä¹™ä¸‘': ['æˆŒ', 'äº¥'], 'ä¸™å¯…': ['æˆŒ', 'äº¥'], 'ä¸å¯': ['æˆŒ', 'äº¥'],
                'æˆŠè¾°': ['æˆŒ', 'äº¥'], 'å·±å·³': ['æˆŒ', 'äº¥'], 'åºšåˆ': ['æˆŒ', 'äº¥'], 'è¾›æœª': ['æˆŒ', 'äº¥'],
                'å£¬ç”³': ['æˆŒ', 'äº¥'], 'ç™¸é…‰': ['æˆŒ', 'äº¥'], 'ç”²æˆŒ': ['ç”³', 'é…‰'], 'ä¹™äº¥': ['ç”³', 'é…‰'],
                'ä¸™å­': ['ç”³', 'é…‰'], 'ä¸ä¸‘': ['ç”³', 'é…‰'], 'æˆŠå¯…': ['ç”³', 'é…‰'], 'å·±å¯': ['ç”³', 'é…‰'],
                'åºšè¾°': ['ç”³', 'é…‰'], 'è¾›å·³': ['ç”³', 'é…‰'], 'å£¬åˆ': ['ç”³', 'é…‰'], 'ç™¸æœª': ['ç”³', 'é…‰'],
                'ç”²ç”³': ['åˆ', 'æœª'], 'ä¹™é…‰': ['åˆ', 'æœª'], 'ä¸™æˆŒ': ['åˆ', 'æœª'], 'ä¸äº¥': ['åˆ', 'æœª'],
                'æˆŠå­': ['åˆ', 'æœª'], 'å·±ä¸‘': ['åˆ', 'æœª'], 'åºšå¯…': ['åˆ', 'æœª'], 'è¾›å¯': ['åˆ', 'æœª'],
                'å£¬è¾°': ['åˆ', 'æœª'], 'ç™¸å·³': ['åˆ', 'æœª'], 'ç”²åˆ': ['è¾°', 'å·³'], 'ä¹™æœª': ['è¾°', 'å·³'],
                'ä¸™ç”³': ['è¾°', 'å·³'], 'ä¸é…‰': ['è¾°', 'å·³'], 'æˆŠæˆŒ': ['è¾°', 'å·³'], 'å·±äº¥': ['è¾°', 'å·³'],
                'åºšå­': ['è¾°', 'å·³'], 'è¾›ä¸‘': ['è¾°', 'å·³'], 'å£¬å¯…': ['è¾°', 'å·³'], 'ç™¸å¯': ['è¾°', 'å·³'],
                'ç”²è¾°': ['å¯…', 'å¯'], 'ä¹™å·³': ['å¯…', 'å¯'], 'ä¸™åˆ': ['å¯…', 'å¯'], 'ä¸æœª': ['å¯…', 'å¯'],
                'æˆŠç”³': ['å¯…', 'å¯'], 'å·±é…‰': ['å¯…', 'å¯'], 'åºšæˆŒ': ['å¯…', 'å¯'], 'è¾›äº¥': ['å¯…', 'å¯'],
                'å£¬å­': ['å¯…', 'å¯'], 'ç™¸ä¸‘': ['å¯…', 'å¯'], 'ç”²å¯…': ['å­', 'ä¸‘'], 'ä¹™å¯': ['å­', 'ä¸‘'],
                'ä¸™è¾°': ['å­', 'ä¸‘'], 'ä¸å·³': ['å­', 'ä¸‘'], 'æˆŠåˆ': ['å­', 'ä¸‘'], 'å·±æœª': ['å­', 'ä¸‘'],
                'åºšç”³': ['å­', 'ä¸‘'], 'è¾›é…‰': ['å­', 'ä¸‘'], 'å£¬æˆŒ': ['å­', 'ä¸‘'], 'ç™¸äº¥': ['å­', 'ä¸‘']
            };
            return KONGWANG_MAP[dayGanzhi] || [];
        }

        // ç”Ÿæˆå®¢æˆ¶å ±å‘ŠHTMLï¼ˆä½¿ç”¨ä½ åŸç¨‹åºçš„å®Œæ•´å‡½æ•° - è¿™é‡Œç®€åŒ–æ˜¾ç¤ºï¼‰
        function generateClientReportHTML(data, result, autoAnalysisResult, kongwangZhi) {
            const tianpanData = result.tianpan.positions;
            const tianjiangData = result.tianjiang.positions;
            const kongwangInfo = {
                dayGanzhi: result.ganzhi.day,
                kongwangZhi: kongwangZhi
            };
            const chatHistoryJSON = JSON.stringify([]);
            const clientJS = generateClientJS(data, tianpanData, tianjiangData, kongwangInfo, chatHistoryJSON);
            const clientHTML = generateClientHTML(data, autoAnalysisResult, clientJS);
            return clientHTML;
        }

        // è¿™é‡Œéœ€è¦åŒ…å«ä½ åŸç¨‹åºçš„ generateClientJS å’Œ generateClientHTML å‡½æ•°
       // âœ… å®Œæ•´ç‰ˆ generateClientJS å‡½æ•¸
// è¤‡è£½é€™æ•´æ®µä»£ç¢¼ï¼Œæ›¿æ› divination.html ä¸­ç¬¬ 828 è¡Œé–‹å§‹çš„ç°¡åŒ–ç‰ˆ
function generateClientJS(data, tianpanData, tianjiangData, kongwangInfo, chatHistoryJSON) {
    const fullReportText = generateStructuredDataText(data, {
        ganzhi: {
            year: data.basicInfo.å››æŸ±å¹²æ”¯.split(' ')[0],
            month: data.basicInfo.å››æŸ±å¹²æ”¯.split(' ')[1],
            day: data.basicInfo.å››æŸ±å¹²æ”¯.split(' ')[2],
            hour: data.basicInfo.å››æŸ±å¹²æ”¯.split(' ')[3]
        },
        yuejiang: {
            name: data.basicInfo.æœˆå°‡ç¯€æ°£.split('(')[0],
            dizhi: data.basicInfo.æœˆå°‡ç¯€æ°£.match(/\((.)\)/)[1],
            current_jieqi: data.basicInfo.æœˆå°‡ç¯€æ°£.split(' - ')[1]
        },
        sike: {},
        sanchuan: { method: data.ketiAnalysis.ç™¼ç”¨å–æ³• },
        keti: { name: data.ketiAnalysis.èª²é«” }
    });

    const reportId = generateSimpleSecureId();

    return `
const REPORT_ID = 'liuren_chat_${reportId}';
const MAX_HISTORY_DISPLAY = 50;
const MAX_HISTORY_API = 20;
let clientChatHistory = [];

const fullReportText = \`${fullReportText.replace(/`/g, '\\`')}\`;

function initClientFontController() {
    const savedScale = localStorage.getItem('client-font-scale') || '1';
    const savedButtonScale = localStorage.getItem('client-button-scale') || '1';
    const savedLineHeightScale = localStorage.getItem('client-line-height-scale') || '1';
    document.documentElement.style.setProperty('--font-scale', savedScale);
    document.documentElement.style.setProperty('--button-scale', savedButtonScale);
    document.documentElement.style.setProperty('--line-height-scale', savedLineHeightScale);
    document.querySelectorAll('.font-size-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.scale === savedScale) btn.classList.add('active');
    });
    document.querySelectorAll('.font-size-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const scale = this.dataset.scale;
            setClientFontScale(scale);
            document.querySelectorAll('.font-size-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
}

function setClientFontScale(scale) {
    const fontScale = parseFloat(scale);
    const buttonScale = Math.min(fontScale, 1.15);
    const lineHeightScale = Math.min(1 + (fontScale - 1) * 0.5, 1.15);
    document.documentElement.style.setProperty('--font-scale', fontScale);
    document.documentElement.style.setProperty('--button-scale', buttonScale);
    document.documentElement.style.setProperty('--line-height-scale', lineHeightScale);
    localStorage.setItem('client-font-scale', fontScale);
    localStorage.setItem('client-button-scale', buttonScale);
    localStorage.setItem('client-line-height-scale', lineHeightScale);
}

async function fetchWithTimeout(r, o = {}, t = 60000) {
    const c = new AbortController();
    const i = setTimeout(() => c.abort(), t);
    try {
        const n = await fetch(r, {...o, signal: c.signal});
        clearTimeout(i);
        return n;
    } catch(e) {
        clearTimeout(i);
        if (e.name === 'AbortError') throw new Error('è«‹æ±‚è¶…æ™‚');
        throw e;
    }
}

function showAlert(m) { alert(m); }

function saveHistory() {
    try {
        localStorage.setItem(REPORT_ID, JSON.stringify(clientChatHistory));
    } catch(e) {
        console.error("ç„¡æ³•å„²å­˜:", e);
    }
}

function loadHistory() {
    try {
        const saved = localStorage.getItem(REPORT_ID);
        return saved ? JSON.parse(saved) : null;
    } catch(e) {
        return null;
    }
}

function addClientMessage(t, c) {
    let d = document.getElementById('client-chat-history');
    if (d.querySelector('.initial-msg')) d.innerHTML = '';
    if (t === 'user') clientChatHistory.push({type: t, content: c});
    else if (t === 'ai') clientChatHistory.push({type: t, content: c});
    while (clientChatHistory.length > MAX_HISTORY_DISPLAY) clientChatHistory.shift();
    if (t !== 'ai-thinking') saveHistory();
    renderHistory(t === 'ai-thinking');
}

function renderHistory(isThinking = false) {
    let d = document.getElementById('client-chat-history');
    if (clientChatHistory.length === 0 && !isThinking) {
        d.innerHTML = '<p class="initial-msg font-adjustable">æ‚¨å¯ä»¥åœ¨æ­¤ç¹¼çºŒå°±æœ¬æ¬¡å åœæå•ã€‚</p>';
        return;
    }
    let historyHtml = clientChatHistory.map(m => {
        if (m.type === 'user') return '<div class="chat-item user font-adjustable"><strong>æ‚¨çš„æå•ï¼š</strong> ' + m.content + '</div>';
        return '<div class="chat-item ai font-adjustable"><strong>Victor AI åŠ©æ‰‹ï¼š</strong> ' + m.content.replace(/\\n/g, '<br>') + '</div>';
    }).join('');
    if (isThinking) {
        historyHtml += '<div class="chat-item ai font-adjustable" data-thinking="true"><strong>Victor AI åŠ©æ‰‹ï¼š</strong> æ­£åœ¨æ€è€ƒä¸­...</div>';
    }
    d.innerHTML = historyHtml;
    d.scrollTop = d.scrollHeight;
}

function removeThinking() {
    let e = document.querySelector('[data-thinking="true"]');
    if (e) e.remove();
}

async function askClientAI() {
    let q = document.getElementById('client-question').value.trim();
    if (!q) { showAlert('è«‹è¼¸å…¥å•é¡Œ'); return; }
    addClientMessage('user', q);
    document.getElementById('client-question').value = '';
    addClientMessage('ai-thinking', '');

    const apiHistory = clientChatHistory.slice(0, -1).slice(-MAX_HISTORY_API);
    const casualPrompt = \`ä½ æ˜¯ç²¾é€šå…­å£¬çš„Victor AIåŠ©æ‰‹ã€‚

ã€ç•¶å‰å åœè³‡æ–™ã€‘
\${fullReportText}

ã€å°è©±è¨˜æ†¶ã€‘
\${apiHistory.map(m => (m.type === 'user' ? 'å®¢æˆ¶' : 'Victor') + 'ï¼š' + m.content).join('\\n')}

ã€å®¢æˆ¶å•é¡Œã€‘
ã€Œ\${q}ã€

è«‹æä¾›å¯¦ç”¨ä¸”å€‹äººåŒ–çš„å›ç­”ã€‚\`;

    try {
        let r = await fetchWithTimeout('https://poe-api-backend.vercel.app/api/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({message: casualPrompt, model: 'GPT-4.1-mini'})
        });
        removeThinking();
        if (!r.ok) throw new Error('AIæœå‹™æš«æ™‚ç„¡æ³•é€£ç·š');
        let data = await r.json();
        addClientMessage('ai', data.text || 'AIæœªèƒ½æä¾›æœ‰æ•ˆå›æ‡‰ã€‚');
    } catch(e) {
        removeThinking();
        addClientMessage('ai', 'âŒ æŠ±æ­‰ï¼Œæˆ‘æš«æ™‚ç„¡æ³•å›ç­”ï¼š' + e.message);
    }
}

function renderClientLiurenPan() {
    const circle = document.getElementById('client-liuren-circle');
    if (!circle) return;
    circle.innerHTML = '';
    const traditionalLayout = ['å·³', 'åˆ', 'æœª', 'ç”³', 'è¾°', '', '', 'é…‰', 'å¯', '', '', 'æˆŒ', 'å¯…', 'ä¸‘', 'å­', 'äº¥'];
    const realTianjiang = ${JSON.stringify(tianjiangData)};
    const realTianpan = ${JSON.stringify(tianpanData)};
    const kongwangData = ${JSON.stringify(kongwangInfo)};
    const kongwangZhi = kongwangData ? kongwangData.kongwangZhi : [];
    traditionalLayout.forEach(zhi => {
        const div = document.createElement('div');
        if (zhi === '') {
            div.className = 'client-grid-item empty';
            div.style.background = 'transparent';
            div.style.border = 'none';
        } else {
            const isKongwang = kongwangZhi.includes(zhi);
            div.className = 'client-grid-item client-dizhi-item' + (isKongwang ? ' client-kongwang-dizhi' : '');
            div.innerHTML =
                '<div class="client-tianjiang">' + (realTianjiang[zhi] || '-') + '</div>' +
                '<div class="client-tianpan">' + (realTianpan[zhi] || '-') + '</div>' +
                '<div class="client-dizhi-name">' + zhi + (isKongwang ? ' ğŸˆ³' : '') + '</div>';
        }
        circle.appendChild(div);
    });
}

function clearClientChat() {
    if (clientChatHistory.length === 0) {
        showAlert('ç›®å‰æ²’æœ‰å°è©±è¨˜éŒ„');
        return;
    }
    if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å°è©±è¨˜éŒ„å—ï¼Ÿ')) {
        clientChatHistory = [];
        if (localStorage.getItem(REPORT_ID)) {
            localStorage.removeItem(REPORT_ID);
        }
        renderHistory();
        showAlert('âœ… å°è©±è¨˜éŒ„å·²æ¸…é™¤');
    }
}

function initializeChat() {
    const initialHistory = ${chatHistoryJSON};
    const savedHistory = loadHistory();
    if (savedHistory && Array.isArray(savedHistory)) {
        clientChatHistory = savedHistory;
    } else {
        clientChatHistory = initialHistory;
    }
    renderHistory();
}

document.addEventListener('DOMContentLoaded', () => {
    initClientFontController();
    initializeChat();
    renderClientLiurenPan();
    document.getElementById('client-send-btn').addEventListener('click', askClientAI);
    document.getElementById('client-clear-btn').addEventListener('click', clearClientChat);
    document.getElementById('client-question').addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            askClientAI();
        }
    });
});
`;
}
// âœ… å®Œæ•´ç‰ˆ generateClientHTML å‡½æ•¸
// é€™æ®µä»£ç¢¼è¦ç·Šæ¥åœ¨ generateClientJS å‡½æ•¸ä¹‹å¾Œ
function generateClientHTML(data, autoAnalysisResult, clientJS) {
    return `<!DOCTYPE html><html lang="zh-HK"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>å¤§å…­å£¬èª²å¼åˆ†æå ±å‘Š</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Microsoft JhengHei','å¾®è»Ÿæ­£é»‘é«”','PingFang TC','Helvetica Neue',Arial,sans-serif;line-height:1.6;background-color:#f5f1e6;background-image:url('https://victorlau.myqnapcloud.com/backpaper.png');background-size:cover;background-position:center;background-attachment:fixed;min-height:100vh;padding:20px;transition:all 0.3s ease}:root{--font-scale:1;--line-height-scale:1;--button-scale:1}@media (min-width: 769px){:root{--font-scale:1.3;--line-height-scale:1.15;--button-scale:1.15}.font-adjustable,.font-adjustable *{font-size:calc(1em * var(--font-scale))!important;line-height:calc(1.6 * var(--line-height-scale))!important}.font-adjustable-small,.font-adjustable-small *{font-size:calc(0.875em * var(--font-scale))!important;line-height:calc(1.5 * var(--line-height-scale))!important}.font-adjustable-large,.font-adjustable-large *{font-size:calc(1.125em * var(--font-scale))!important;line-height:calc(1.7 * var(--line-height-scale))!important}.font-adjustable-xl,.font-adjustable-xl *{font-size:calc(1.25em * var(--font-scale))!important;line-height:calc(1.7 * var(--line-height-scale))!important}.ai-analysis,.ai-analysis *{font-size:calc(1.05em * var(--font-scale))!important;line-height:calc(1.8 * var(--line-height-scale))!important}.info-value,.info-value *{font-size:calc(0.95em * var(--font-scale))!important;line-height:calc(1.6 * var(--line-height-scale))!important}#client-chat-history,#client-chat-history *{font-size:calc(1em * var(--font-scale))!important;line-height:calc(1.6 * var(--line-height-scale))!important}.transmission-content,.transmission-content *,.course-content,.course-content *{font-size:calc(0.85em * var(--font-scale))!important;line-height:calc(1.5 * var(--line-height-scale))!important}}.font-size-controller{position:fixed;top:20px;right:20px;z-index:9999;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border-radius:25px;padding:8px 12px;box-shadow:0 4px 20px rgba(0,0,0,0.15);border:1px solid rgba(255,255,255,0.3);display:flex;align-items:center;gap:8px;transition:all 0.3s ease}.font-size-controller:hover{transform:translateY(-1px);box-shadow:0 6px 25px rgba(0,0,0,0.2)}.font-size-btn{background:none;border:1px solid #e2e8f0;color:#4a5568;padding:4px 8px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s ease;min-width:24px;height:24px;display:flex;align-items:center;justify-content:center}.font-size-btn:hover{background:#f7fafc;border-color:#5D5CDE;color:#5D5CDE}.font-size-btn.active{background:#5D5CDE;color:white;border-color:#5D5CDE}.button-adjustable{padding:calc(8px * var(--button-scale)) calc(16px * var(--button-scale));font-size:calc(0.875em * var(--font-scale))}.input-adjustable{padding:calc(8px * var(--button-scale)) calc(12px * var(--button-scale));font-size:calc(1em * var(--font-scale))}@media(max-width:768px){.font-size-controller{display:none}}.main-container{max-width:80vw;margin:0 auto;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.15);overflow:hidden;position:relative}.taichi-bg{position:absolute;width:140px;height:140px;background-image:url('https://victorlau.myqnapcloud.com/taichi.webp');background-size:contain;background-repeat:no-repeat;opacity:0.15;z-index:1;animation:rotate 20s linear infinite;pointer-events:none}.taichi-bg.left{top:-30px;left:-30px}.taichi-bg.right{bottom:-30px;right:-30px}.bagua-bg{position:absolute;bottom:-120px;right:-120px;width:300px;height:300px;background-image:url('https://victorlau.myqnapcloud.com/taichi.webp');background-size:contain;background-repeat:no-repeat;opacity:0.03;z-index:0;animation:slowRotate 80s linear infinite reverse;pointer-events:none}@keyframes rotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}@keyframes slowRotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}}@keyframes fadeIn{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}@media(max-width:768px){.taichi-bg{width:80px;height:80px}.bagua-bg{width:200px;height:200px}}.header{background-color:#336633;background-image:linear-gradient(120deg,#336633,#2f4f4f);color:white;padding:40px 30px;text-align:center;position:relative;overflow:hidden;box-shadow:0 4px 6px rgba(0,0,0,0.1)}.header::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background-image:url('https://victorlau.myqnapcloud.com/taichi.webp');background-repeat:no-repeat;background-position:right center;background-size:200px;opacity:0.1;z-index:0;animation:pulse 8s infinite ease-in-out}.header h1{font-size:2.2em;margin-bottom:15px;position:relative;z-index:2}.header .subtitle{font-size:1.1em;opacity:0.9;margin-bottom:10px;position:relative;z-index:2}.header .meta{font-size:0.9em;opacity:0.8;position:relative;z-index:2}.content{padding:0}.section{margin:0;border:none}.section-header{background:linear-gradient(90deg,#f8f9ff 0%,#e8f0ff 100%);padding:20px 30px;border-left:6px solid #336633;margin:0}.section-header h3{font-size:1.4em;color:#2d3748;margin:0;display:flex;align-items:center;gap:10px}.section-content{padding:25px 30px}.ai-analysis{background:linear-gradient(135deg,#fff9e6 0%,#fef3c7 100%);border:1px solid #f59e0b;border-radius:15px;padding:25px;line-height:1.8;font-size:1.05em;color:#92400e;box-shadow:0 4px 15px rgba(245,158,11,0.1)}.data-grid{display:grid;gap:20px;margin-top:20px}@media(min-width:768px){.data-grid{grid-template-columns:repeat(2,1fr)}}.info-card{background:linear-gradient(135deg,#ffffff 0%,#f8fafc 100%);border:1px solid #e2e8f0;border-radius:15px;padding:20px;box-shadow:0 4px 15px rgba(0,0,0,0.05);transition:transform 0.2s ease,box-shadow 0.2s ease}.info-card:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.1)}.info-card h4{color:#2d3748;font-size:1.2em;margin-bottom:15px;display:flex;align-items:center;gap:8px;padding-bottom:10px;border-bottom:2px solid #e2e8f0}.info-value{background:linear-gradient(135deg,#edf2f7 0%,#f7fafc 100%);padding:15px;border-radius:10px;margin-bottom:12px;border-left:4px solid #336633;font-size:0.95em;line-height:1.6}.info-value strong{color:#2d3748;font-weight:600}.four-courses{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-top:15px}.course-card{background:linear-gradient(135deg,#ffffff 0%,#fafbfc 100%);border:2px solid #e2e8f0;border-radius:12px;padding:15px;text-align:center;transition:all 0.3s ease}.course-card:hover{border-color:#336633;transform:translateY(-3px);box-shadow:0 8px 20px rgba(51,102,51,0.15)}.course-title{font-weight:bold;color:#4a5568;margin-bottom:10px;font-size:0.9em}.course-content{font-size:0.85em;line-height:1.5}.course-tianjiang{color:#d69e2e;font-weight:bold;margin:8px 0}.course-positions{color:#2d3748}.three-transmissions{display:grid;gap:15px;margin-top:15px}.transmission-card{background:linear-gradient(135deg,#f0fff4 0%,#e6ffed 100%);border:2px solid #68d391;border-radius:12px;padding:18px;transition:all 0.3s ease}.transmission-card:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(104,211,145,0.2)}.transmission-header{display:flex;justify-content:between;align-items:center;margin-bottom:10px}.transmission-type{background:#68d391;color:white;padding:6px 12px;border-radius:20px;font-size:0.8em;font-weight:bold}.transmission-content{font-size:0.95em;color:#2f855a;line-height:1.6}.chat-interface{background:linear-gradient(135deg,#f7fafc 0%,#edf2f7 100%);border-radius:15px;padding:25px;margin-top:20px;border:1px solid #e2e8f0}.chat-history{background:white;border:2px solid #e2e8f0;border-radius:12px;padding:20px;max-height:400px;overflow-y:auto;margin-bottom:15px;box-shadow:inset 0 2px 4px rgba(0,0,0,0.05)}.chat-item{margin-bottom:15px;line-height:1.6}.chat-item.user{text-align:right}.chat-item.user strong{color:#3182ce;background:linear-gradient(135deg,#ebf8ff 0%,#bee3f8 100%);padding:2px 8px;border-radius:15px}.chat-item.ai strong{color:#38a169;background:linear-gradient(135deg,#f0fff4 0%,#c6f6d5 100%);padding:2px 8px;border-radius:15px}.chat-input{width:100%;padding:15px;border:2px solid #e2e8f0;border-radius:12px;font-size:1em;resize:vertical;margin-bottom:15px;transition:border-color 0.3s ease}.chat-input:focus{outline:none;border-color:#336633;box-shadow:0 0 0 3px rgba(51,102,51,0.1)}@media (min-width: 769px){.chat-input,.input-adjustable{font-size:calc(1em * var(--font-scale))!important;padding:calc(15px * var(--button-scale))!important;line-height:calc(1.5 * var(--line-height-scale))!important}}.chat-button{background:linear-gradient(135deg,#336633 0%,#2f4f4f 100%);color:white;border:none;padding:12px 25px;border-radius:10px;font-size:1em;font-weight:600;cursor:pointer;transition:all 0.3s ease}.chat-button:hover{transform:translateY(-1px);box-shadow:0 5px 15px rgba(51,102,51,0.4)}.initial-msg{text-align:center;color:#718096;font-style:italic;padding:20px}.client-dizhi-circle{position:relative;width:100%;max-width:320px;height:auto;aspect-ratio:1/1;margin:20px auto;display:grid;grid-template-columns:repeat(4,1fr);grid-template-rows:repeat(4,1fr);gap:2px;background:transparent}.client-grid-item{display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:12px;min-height:0;padding:4px}.client-dizhi-item{border:1px solid #6B7280;background:white;border-radius:6px}.client-tianjiang{font-weight:bold;color:#DC2626;font-size:10px;margin-bottom:1px}.client-tianpan{font-weight:bold;color:#2563EB;font-size:11px;margin-bottom:1px}.client-dizhi-name{color:#374151;font-weight:600;font-size:11px}.client-kongwang-dizhi{background:linear-gradient(135deg,#fef2f2 0%,#fee2e2 100%)!important;border-color:#f87171!important;opacity:0.7!important}.client-pan-legend{text-align:center;margin-top:15px;font-size:12px;color:#6b7280}@media(max-width:768px){body{padding:5px!important;overflow-x:hidden!important;max-width:100vw!important}html{overflow-x:hidden!important}*{max-width:100%!important;box-sizing:border-box!important;word-wrap:break-word!important}.main-container{max-width:100%!important;margin:0!important;border-radius:0!important;width:100%!important;overflow-x:hidden!important}.section-content{padding:15px 8px!important}.chat-interface{padding:15px 10px!important}.chat-history{padding:15px 10px!important}.chat-item{text-align:left!important;margin:0 5px 15px 5px!important;padding:10px!important;background:rgba(255,255,255,0.9)!important;border-radius:8px!important;word-wrap:break-word!important;font-size:18px!important;line-height:1.5!important}.chat-item.user{background:rgba(93,92,222,0.1)!important;border-left:3px solid #5D5CDE!important}.chat-item.ai{background:rgba(56,161,105,0.1)!important;border-left:3px solid #38a169!important}.chat-item strong{display:block!important;background:none!important;padding:0!important;border-radius:0!important;margin-bottom:5px!important;font-size:16px!important;font-weight:600!important}.chat-input{font-size:18px!important;line-height:1.4!important}.ai-analysis{font-size:15px!important;line-height:1.6!important}.ai-analysis,.chat-message,.chat-item,.analysis-content,.section-content{overflow-x:hidden!important;word-break:break-all!important;white-space:pre-wrap!important}pre,code{white-space:pre-wrap!important;word-break:break-all!important;overflow-x:hidden!important;max-width:100%!important}}@media(max-width:400px){.client-dizhi-circle{gap:1px;max-width:280px}.client-grid-item{font-size:10px;padding:2px}.client-tianjiang{font-size:9px}.client-tianpan{font-size:10px}.client-dizhi-name{font-size:10px}}</style></head><body><div class="font-size-controller"><span class="font-adjustable-small" style="color:#718096;">å­—é«”</span><button class="font-size-btn" data-scale="0.9" title="å°è™Ÿå­—é«”">A-</button><button class="font-size-btn active" data-scale="1" title="æ­£å¸¸å­—é«”">A</button><button class="font-size-btn" data-scale="1.15" title="å¤§è™Ÿå­—é«”">A+</button><button class="font-size-btn" data-scale="1.3" title="ç‰¹å¤§å­—é«”">A++</button></div><div class="main-container"><div class="bagua-bg"></div><div class="header"><div class="taichi-bg left"></div><div class="taichi-bg right"></div><h1 class="font-adjustable-xl">ğŸ§® å¤§å…­å£¬å°ˆæ¥­èª²å¼åˆ†æå ±å‘Š</h1><div class="subtitle font-adjustable">å å•äº‹é …ï¼š${data.basicInfo.å å•äº‹é …}</div><div class="meta font-adjustable-small">ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')} | Victor AI åŠ©æ‰‹åˆ†æ</div></div><div class="content"><div class="section"><div class="section-header"><h3 class="font-adjustable-large">ğŸŒŸ Victor AI åŠ©æ‰‹å°ˆæ¥­åˆ†æ</h3></div><div class="section-content"><div class="ai-analysis font-adjustable">${autoAnalysisResult}</div></div></div><div class="section"><div class="section-header"><h3 class="font-adjustable-large">ğŸ“Š è©³ç´°ç›¤å¼è³‡æ–™</h3></div><div class="section-content"><div class="data-grid"><div class="info-card"><h4 class="font-adjustable">ğŸ“… åŸºæœ¬ä¿¡æ¯</h4><div class="info-value font-adjustable-small"><strong>å äº‹æ™‚é–“ï¼š</strong>${data.basicInfo.æ’ç›¤æ™‚é–“}</div><div class="info-value font-adjustable-small"><strong>å››æŸ±å¹²æ”¯ï¼š</strong>${data.basicInfo.å››æŸ±å¹²æ”¯è©³ç´°}</div><div class="info-value font-adjustable-small"><strong>æœˆå°‡ç¯€æ°£ï¼š</strong>${data.basicInfo.æœˆå°‡ç¯€æ°£}</div></div><div class="info-card"><h4 class="font-adjustable">ğŸ“‹ èª²é«”èˆ‡ç™¼ç”¨</h4><div class="info-value font-adjustable-small"><strong>èª²é«”ï¼š</strong>${data.ketiAnalysis.èª²é«”}</div><div class="info-value font-adjustable-small"><strong>èª²é«”é‡‹ç¾©ï¼š</strong>${data.ketiAnalysis.èª²é«”é‡‹ç¾©}</div><div class="info-value font-adjustable-small"><strong>ç™¼ç”¨å–æ³•ï¼š</strong>${data.ketiAnalysis.ç™¼ç”¨å–æ³•}</div></div></div><div class="info-card" style="grid-column:1/-1"><h4 class="font-adjustable">ğŸ¯ å››èª²è©³è§£</h4><div class="four-courses">${data.sike.slice().reverse().map(c=>`<div class="course-card"><div class="course-title font-adjustable-small">${c.èª²}</div><div class="course-content"><div class="course-tianjiang font-adjustable-small">å¤©å°‡ï¼š${c.å¤©å°‡}</div><div class="course-positions font-adjustable-small">ä¸Šæ–¹ï¼šã€${c.ä¸Š}ã€‘<br>ä¸‹æ–¹ï¼šã€${c.ä¸‹}ã€‘</div></div></div>`).join('')}</div></div><div class="info-card" style="grid-column:1/-1"><h4 class="font-adjustable">ğŸ”„ ä¸‰å‚³æµè½‰</h4><div class="three-transmissions"><div class="transmission-card"><div class="transmission-header"><span class="transmission-type font-adjustable-small">åˆå‚³</span></div><div class="transmission-content font-adjustable-small">${data.sanchuan.åˆå‚³}</div></div><div class="transmission-card"><div class="transmission-header"><span class="transmission-type font-adjustable-small">ä¸­å‚³</span></div><div class="transmission-content font-adjustable-small">${data.sanchuan.ä¸­å‚³}</div></div><div class="transmission-card"><div class="transmission-header"><span class="transmission-type font-adjustable-small">æœ«å‚³</span></div><div class="transmission-content font-adjustable-small">${data.sanchuan.æœ«å‚³}</div></div></div></div></div></div><div class="section"><div class="section-header"><h3 class="font-adjustable-large">ğŸ¯ å¤§å…­å£¬ç›¤å¼åœ–</h3></div><div class="section-content"><div id="client-liuren-circle" class="client-dizhi-circle"></div><div class="client-pan-legend font-adjustable-small"><span class="client-tianjiang">å¤©å°‡</span> â€¢ <span class="client-tianpan">å¤©ç›¤</span> â€¢ <span class="client-dizhi-name">åœ°ç›¤</span></div></div></div><div class="section"><div class="section-header"><h3 class="font-adjustable-large">ğŸ’¬ èˆ‡ Victor AI åŠ©æ‰‹å°è©±</h3></div><div class="section-content"><div class="chat-interface"><div id="client-chat-history" class="chat-history"><p class="initial-msg font-adjustable">æ‚¨å¯ä»¥åœ¨æ­¤ç¹¼çºŒå°±æœ¬æ¬¡å åœæå•</p></div><textarea id="client-question" class="chat-input input-adjustable" rows="3" placeholder="è«‹è¼¸å…¥æ‚¨é—œæ–¼æœ¬æ¬¡å åœçš„å•é¡Œ..."></textarea><div style="display:flex;gap:10px;align-items:center;"><button id="client-send-btn" class="chat-button button-adjustable" style="flex:1;">ç™¼é€å•é¡Œ</button><button id="client-clear-btn" class="chat-button button-adjustable" style="background:linear-gradient(135deg,#dc2626 0%,#b91c1c 100%);min-width:100px;" title="æ¸…é™¤æ‰€æœ‰å°è©±è¨˜éŒ„">ğŸ—‘ï¸ æ¸…é™¤</button></div></div></div></div><div class="section" style="margin-top:40px;border-top:2px solid #e2e8f0;"><div class="section-content" style="padding:20px 30px;"><div style="background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);border-radius:12px;padding:20px;border-left:4px solid #6b7280;"><h4 style="color:#4a5568;font-size:1.1em;margin-bottom:12px;display:flex;align-items:center;gap:8px;" class="font-adjustable">ğŸ”’ é‡è¦æé†’</h4><div style="color:#6b7280;font-size:0.9em;line-height:1.6;" class="font-adjustable-small"><div style="margin-bottom:6px;">â€¢ å•ç­”è³‡æ–™ï¼šä½¿ç”¨å¾Œè‡ªå‹•åˆªé™¤</div><div style="margin-bottom:6px;">â€¢ å ±å‘Šæª”æ¡ˆï¼šç³»çµ±ç´„æ–¼ 30 å¤©è‡ªè¡Œåˆªé™¤</div><div>â€¢ æœ¬æœå‹™åƒ…ä¾›å…­å£¬æ–‡åŒ–åƒè€ƒï¼Œé‡å¤§æ±ºç­–è«‹è«®è©¢å°ˆæ¥­å»ºè­°</div></div></div></div></div></div></div><script>${clientJS}<\/script></body></html>`;
}

    </script>
</body>
</html>
