<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§å…­å£¬æ™ºæ…§æ’ç›¤ - ä»˜è²»æ–¹æ¡ˆé¸æ“‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- âœ… PayPal SDK - è«‹æ›¿æ›æˆä½ çš„çœŸå¯¦ Client ID -->
    <script src="https://www.paypal.com/sdk/js?client-id=ASAUF0ean7gjcE1x4TVCG43mQlOBuRGzwfK1Vqr_yfijiJP8fu-IbsJCzpf2WWxJFfztG5iwULW8PhsJ&currency=HKD"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', Arial, "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        .plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .plan-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
            cursor: pointer;
            border: 3px solid transparent;
        }
        .plan-card:hover {
            transform: translateY(-5px);
        }
        .plan-card.selected {
            border-color: #336633;
            box-shadow: 0 10px 30px rgba(51,102,51,0.4);
        }
        .plan-title {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }
        .plan-price {
            font-size: 36px;
            font-weight: bold;
            color: #336633;
            margin-bottom: 15px;
        }
        .plan-features {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }
        .plan-features li {
            padding: 8px 0;
            color: #4a5568;
        }
        .plan-features li:before {
            content: "âœ“ ";
            color: #68d391;
            font-weight: bold;
            margin-right: 5px;
        }
        .paypal-button-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .has-code-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .code-input {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            text-align: center;
            text-transform: uppercase;
        }
        .use-code-btn {
            background: linear-gradient(135deg, #336633 0%, #2f4f4f 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
        }
        .use-code-btn:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="font-size: 36px; margin-bottom: 10px;">ğŸ§® å¤§å…­å£¬æ™ºæ…§æ’ç›¤</h1>
            <p style="font-size: 18px; opacity: 0.9;">Victor AI ä¸»ç† Â· å°ˆæ¥­å…­å£¬åˆ†ææœå‹™</p>
        </div>

        <div class="plans">
            <!-- âœ… å–®æ¬¡è³¼è²·é¸é … (æ¸¬è©¦ï¼šé¡¯ç¤º399å…ƒï¼Œå¯¦éš›æ‰£1å…ƒ) -->
            <div class="plan-card" onclick="selectPlan('single', 1, 399)" id="plan-single">
                <div class="plan-title">å–®æ¬¡èµ·å¦</div>
                <div class="plan-price">HK$ 399</div>
                <ul class="plan-features">
                    <li>1 æ¬¡å°ˆæ¥­èµ·å¦åˆ†æ</li>
                    <li>Victor AI æ·±åº¦è§£è®€</li>
                    <li>å®Œæ•´èª²å¼å ±å‘Š</li>
                    <li>éš¨æ™‚éš¨åœ°æŸ¥é–±</li>
                </ul>
            </div>

            <!-- 3æ¬¡å¥—é¤ (æ¸¬è©¦ï¼šé¡¯ç¤º1000å…ƒï¼Œå¯¦éš›æ‰£10å…ƒ) -->
            <div class="plan-card" onclick="selectPlan('triple', 10, 1000)" id="plan-triple">
                <div class="plan-title">3æ¬¡å¥—é¤ ğŸ</div>
                <div class="plan-price">HK$ 1,000</div>
                <div style="background: #f0fff4; color: #38a169; padding: 8px; border-radius: 8px; margin-bottom: 10px; font-weight: 600;">
                    æ–°å®¢å„ªæƒ ï¼šé€ 2 æ¬¡ï¼å…± 5 æ¬¡
                </div>
                <ul class="plan-features">
                    <li>3 æ¬¡èµ·å¦ + è´ˆé€ 2 æ¬¡</li>
                    <li>å¹³å‡æ¯æ¬¡åƒ… HK$200</li>
                    <li>30å¤©å…§æœ‰æ•ˆ</li>
                    <li>æœ€è¶…å€¼é¸æ“‡</li>
                </ul>
            </div>
        </div>

        <!-- PayPal æŒ‰éˆ•å®¹å™¨ -->
        <div class="paypal-button-container" id="paypal-container" style="display:none;">
            <h3 style="text-align:center; margin-bottom:20px; color:#2d3748;">è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼</h3>
            <div id="paypal-button"></div>
        </div>

        <!-- å·²æœ‰èµ·å¦ç¢¼ -->
        <div class="has-code-section">
            <h3 style="color:#2d3748; margin-bottom:15px;">å·²æœ‰èµ·å¦ç¢¼ï¼Ÿ</h3>
            <input
                type="text"
                class="code-input"
                id="existing-code"
                placeholder="è«‹è¼¸å…¥èµ·å¦ç¢¼ (ä¾‹ï¼šLR-XXXX-XXXX)"
                maxlength="13"
            >
            <br>
            <button class="use-code-btn" onclick="useExistingCode()">é–‹å§‹èµ·å¦</button>
        </div>
    </div>

    <script>
        let selectedPlan = null;
        let actualAmount = 0;  // âœ… å¯¦éš›æ‰£æ¬¾é‡‘é¡
        let displayAmount = 0; // âœ… é¡¯ç¤ºé‡‘é¡

        // é¸æ“‡æ–¹æ¡ˆ
        function selectPlan(planType, realPrice, showPrice) {
            selectedPlan = planType;
            actualAmount = realPrice;   // âœ… å¯¦éš›æ‰£æ¬¾é‡‘é¡ (1å…ƒ æˆ– 10å…ƒ)
            displayAmount = showPrice;  // âœ… é¡¯ç¤ºé‡‘é¡ (399å…ƒ æˆ– 1000å…ƒ)

            // æ›´æ–°UI
            document.querySelectorAll('.plan-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('plan-' + planType).classList.add('selected');

            // é¡¯ç¤ºPayPalæŒ‰éˆ•å®¹å™¨
            document.getElementById('paypal-container').style.display = 'block';

            // æ¸²æŸ“PayPalæŒ‰éˆ•
            renderPayPalButton();
        }

        // æ¸²æŸ“PayPalæŒ‰éˆ•
        function renderPayPalButton() {
            const container = document.getElementById('paypal-button');
            container.innerHTML = ''; // æ¸…ç©ºèˆŠæŒ‰éˆ•

            paypal.Buttons({
                createOrder: async function(data, actions) {
                    try {
                        const response = await fetch('/api/paypal-create-order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                planType: selectedPlan,
                                // âœ… å‚³éå¯¦éš›æ‰£æ¬¾é‡‘é¡çµ¦å¾Œç«¯
                                amount: actualAmount
                            })
                        });

                        const order = await response.json();
                        if (!order.id) {
                            throw new Error('ç„¡æ³•å‰µå»ºè¨‚å–®');
                        }
                        return order.id;
                    } catch (error) {
                        alert('å‰µå»ºè¨‚å–®å¤±æ•—ï¼š' + error.message);
                        throw error;
                    }
                },

                onApprove: async function(data, actions) {
                    try {
                        const response = await fetch('/api/paypal-capture-order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                orderID: data.orderID,
                                planType: selectedPlan
                            })
                        });

                        const result = await response.json();

                        if (result.success && result.accessCode) {
                            // ä»˜æ¬¾æˆåŠŸï¼Œè·³è½‰åˆ°èµ·å¦é é¢
                            window.location.href = `divination.html?code=${result.accessCode}`;
                        } else {
                            alert('ä»˜æ¬¾è™•ç†å¤±æ•—ï¼š' + (result.error || 'æœªçŸ¥éŒ¯èª¤'));
                        }
                    } catch (error) {
                        alert('ä»˜æ¬¾ç¢ºèªå¤±æ•—ï¼š' + error.message);
                    }
                },

                onError: function(err) {
                    console.error('PayPaléŒ¯èª¤:', err);
                    alert('PayPalä»˜æ¬¾éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦');
                }
            }).render('#paypal-button');
        }

        // ä½¿ç”¨å·²æœ‰èµ·å¦ç¢¼
        function useExistingCode() {
            const code = document.getElementById('existing-code').value.trim().toUpperCase();

            if (!code) {
                alert('è«‹è¼¸å…¥èµ·å¦ç¢¼');
                return;
            }

            // é©—è­‰æ ¼å¼ (ç°¡å–®é©—è­‰)
            if (!code.startsWith('LR-')) {
                alert('èµ·å¦ç¢¼æ ¼å¼éŒ¯èª¤ï¼Œæ‡‰ç‚º LR-XXXX-XXXX');
                return;
            }

            // è·³è½‰åˆ°èµ·å¦é é¢
            window.location.href = `divination.html?code=${code}`;
        }

        // è‡ªå‹•æ ¼å¼åŒ–èµ·å¦ç¢¼è¼¸å…¥
        document.getElementById('existing-code').addEventListener('input', function(e) {
            let value = e.target.value.toUpperCase().replace(/[^A-Z0-9-]/g, '');
            e.target.value = value;
        });
    </script>
</body>
</html>
