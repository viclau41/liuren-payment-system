<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大六壬智慧排盤 - 付費方案選擇</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ✅ PayPal SDK - 請替換成你的真實 Client ID -->
    <script src="https://www.paypal.com/sdk/js?client-id=ASAUF0ean7gjcE1x4TVCG43mQlOBuRGzwfK1Vqr_yfijiJP8fu-IbsJCzpf2WWxJFfztG5iwULW8PhsJ&currency=HKD"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', Arial, "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        .plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .plan-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
            cursor: pointer;
            border: 3px solid transparent;
        }
        .plan-card:hover {
            transform: translateY(-5px);
        }
        .plan-card.selected {
            border-color: #336633;
            box-shadow: 0 10px 30px rgba(51,102,51,0.4);
        }
        .plan-title {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }
        .plan-price {
            font-size: 36px;
            font-weight: bold;
            color: #336633;
            margin-bottom: 15px;
        }
        .plan-features {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }
        .plan-features li {
            padding: 8px 0;
            color: #4a5568;
        }
        .plan-features li:before {
            content: "✓ ";
            color: #68d391;
            font-weight: bold;
            margin-right: 5px;
        }
        .paypal-button-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .has-code-section {
            background: white;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .code-input {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            text-align: center;
            text-transform: uppercase;
        }
        .use-code-btn {
            background: linear-gradient(135deg, #336633 0%, #2f4f4f 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
        }
        .use-code-btn:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="font-size: 36px; margin-bottom: 10px;">🧮 大六壬智慧排盤</h1>
            <p style="font-size: 18px; opacity: 0.9;">Victor AI 主理 · 專業六壬分析服務</p>
        </div>

        <div class="plans">
            <!-- ✅ 單次購買選項 (測試：顯示399元，實際扣1元) -->
            <div class="plan-card" onclick="selectPlan('single', 1, 399)" id="plan-single">
                <div class="plan-title">單次起卦</div>
                <div class="plan-price">HK$ 399</div>
                <ul class="plan-features">
                    <li>1 次專業起卦分析</li>
                    <li>Victor AI 深度解讀</li>
                    <li>完整課式報告</li>
                    <li>隨時隨地查閱</li>
                </ul>
            </div>

            <!-- 3次套餐 (測試：顯示1000元，實際扣10元) -->
            <div class="plan-card" onclick="selectPlan('triple', 10, 1000)" id="plan-triple">
                <div class="plan-title">3次套餐 🎁</div>
                <div class="plan-price">HK$ 1,000</div>
                <div style="background: #f0fff4; color: #38a169; padding: 8px; border-radius: 8px; margin-bottom: 10px; font-weight: 600;">
                    新客優惠：送 2 次！共 5 次
                </div>
                <ul class="plan-features">
                    <li>3 次起卦 + 贈送 2 次</li>
                    <li>平均每次僅 HK$200</li>
                    <li>30天內有效</li>
                    <li>最超值選擇</li>
                </ul>
            </div>
        </div>

        <!-- PayPal 按鈕容器 -->
        <div class="paypal-button-container" id="paypal-container" style="display:none;">
            <h3 style="text-align:center; margin-bottom:20px; color:#2d3748;">請選擇付款方式</h3>
            <div id="paypal-button"></div>
        </div>

        <!-- 已有起卦碼 -->
        <div class="has-code-section">
            <h3 style="color:#2d3748; margin-bottom:15px;">已有起卦碼？</h3>
            <input
                type="text"
                class="code-input"
                id="existing-code"
                placeholder="請輸入起卦碼 (例：LR-XXXX-XXXX)"
                maxlength="13"
            >
            <br>
            <button class="use-code-btn" onclick="useExistingCode()">開始起卦</button>
        </div>
    </div>

    <script>
        let selectedPlan = null;
        let actualAmount = 0;  // ✅ 實際扣款金額
        let displayAmount = 0; // ✅ 顯示金額

        // 選擇方案
        function selectPlan(planType, realPrice, showPrice) {
            selectedPlan = planType;
            actualAmount = realPrice;   // ✅ 實際扣款金額 (1元 或 10元)
            displayAmount = showPrice;  // ✅ 顯示金額 (399元 或 1000元)

            // 更新UI
            document.querySelectorAll('.plan-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.getElementById('plan-' + planType).classList.add('selected');

            // 顯示PayPal按鈕容器
            document.getElementById('paypal-container').style.display = 'block';

            // 渲染PayPal按鈕
            renderPayPalButton();
        }

        // 渲染PayPal按鈕
        function renderPayPalButton() {
            const container = document.getElementById('paypal-button');
            container.innerHTML = ''; // 清空舊按鈕

            paypal.Buttons({
                createOrder: async function(data, actions) {
                    try {
                        const response = await fetch('/api/paypal-create-order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                planType: selectedPlan,
                                // ✅ 傳遞實際扣款金額給後端
                                amount: actualAmount
                            })
                        });

                        const order = await response.json();
                        if (!order.id) {
                            throw new Error('無法創建訂單');
                        }
                        return order.id;
                    } catch (error) {
                        alert('創建訂單失敗：' + error.message);
                        throw error;
                    }
                },

                onApprove: async function(data, actions) {
                    try {
                        const response = await fetch('/api/paypal-capture-order', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                orderID: data.orderID,
                                planType: selectedPlan
                            })
                        });

                        const result = await response.json();

                        if (result.success && result.accessCode) {
                            // 付款成功，跳轉到起卦頁面
                            window.location.href = `divination.html?code=${result.accessCode}`;
                        } else {
                            alert('付款處理失敗：' + (result.error || '未知錯誤'));
                        }
                    } catch (error) {
                        alert('付款確認失敗：' + error.message);
                    }
                },

                onError: function(err) {
                    console.error('PayPal錯誤:', err);
                    alert('PayPal付款過程中發生錯誤，請重試');
                }
            }).render('#paypal-button');
        }

        // 使用已有起卦碼
        function useExistingCode() {
            const code = document.getElementById('existing-code').value.trim().toUpperCase();

            if (!code) {
                alert('請輸入起卦碼');
                return;
            }

            // 驗證格式 (簡單驗證)
            if (!code.startsWith('LR-')) {
                alert('起卦碼格式錯誤，應為 LR-XXXX-XXXX');
                return;
            }

            // 跳轉到起卦頁面
            window.location.href = `divination.html?code=${code}`;
        }

        // 自動格式化起卦碼輸入
        document.getElementById('existing-code').addEventListener('input', function(e) {
            let value = e.target.value.toUpperCase().replace(/[^A-Z0-9-]/g, '');
            e.target.value = value;
        });
    </script>
</body>
</html>
